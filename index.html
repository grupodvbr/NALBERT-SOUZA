<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Livro de Caixa — Pop‑up</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0a0a;--panel:#111;--muted:#161616;--ink:#f6f7fb;--ok:#16a34a;--bad:#dc2626;--warn:#f59e0b;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 Inter,system-ui,Segoe UI,Arial}
    header{padding:16px 18px;border-bottom:1px solid #1f1f1f;display:flex;justify-content:space-between;align-items:center}
    h1{font-size:16px;margin:0}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #2a2a2a;background:#0e0e0e;padding:6px 10px;border-radius:999px;font-size:12px}
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    .panel{background:var(--panel);border:1px solid #1d1d1d;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:grid;gap:12px}
    .row.cols-4{grid-template-columns:repeat(4,1fr)}
    .card{background:var(--muted);border:1px solid #222;border-radius:14px;padding:14px}
    .kpi .label{opacity:.85;font-size:12px}
    .kpi .value{font-size:22px;font-weight:700;margin-top:6px}
    .kpi.ok .value{color:var(--ok)}
    .kpi.bad .value{color:var(--bad)}
    .kpi.warn .value{color:var(--warn)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #222}
    th{position:sticky;top:0;background:#151515;text-align:left}
    .right{text-align:right}
    .hint{opacity:.7}
    .empty{opacity:.6;text-align:center;padding:24px}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    select,input{background:#0e0e0e;border:1px solid #222;color:var(--ink);border-radius:10px;padding:8px 10px}
  </style>
</head>
<body>
  <header>
    <h1 id="ttl">Livro de Caixa — Pop‑up</h1>
    <span class="pill"><span class="hint">Atualizado:</span> <span id="updated">—</span></span>
  </header>

  <div class="wrap">
    <div class="panel">
      <!-- Filtros locais (recebem valores do index, mas também podem ser usados no pop-up) -->
      <div class="filters">
        <label>
          <span class="hint">Empresa</span><br>
          <select id="empresa"></select>
        </label>
        <label>
          <span class="hint">Data inicial</span><br>
          <input type="date" id="dtIni">
        </label>
        <label>
          <span class="hint">Data final</span><br>
          <input type="date" id="dtFim">
        </label>
        <label style="flex:1 1 260px">
          <span class="hint">Buscar</span><br>
          <input type="text" id="busca" placeholder="histórico ou complemento">
        </label>
      </div>

      <div class="row cols-4" style="margin-top:12px">
        <div class="card kpi" id="kpi-saldo-impl">
          <div class="label">Saldo na implantação</div>
          <div class="value">—</div>
        </div>
        <div class="card kpi" id="kpi-entradas">
          <div class="label">Total de Entradas</div>
          <div class="value">—</div>
        </div>
        <div class="card kpi" id="kpi-saidas">
          <div class="label">Total de Saídas</div>
          <div class="value">—</div>
        </div>
        <div class="card kpi" id="kpi-saldo">
          <div class="label">Saldo no Período</div>
          <div class="value">—</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="overflow:auto;max-height:66vh">
          <table id="tbl">
            <thead>
              <tr>
                <th style="width:120px">Data</th>
                <th>Histórico</th>
                <th>Complemento</th>
                <th class="right" style="width:120px">Entrada</th>
                <th class="right" style="width:120px">Saída</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="empty" id="empty" hidden>Nenhum lançamento no período.</div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ====== CONFIGURE AQUI ======
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzqg8GEPFmod6W1xPxneXHAC6LRmnNAastew3QJtMpsf8mWwRowcZKZoNgRQskBM0-p/exec?action=list";
    // =============================

    const fmt = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    let raw = null;       // payload completo do servidor
    let current = null;   // empresa selecionada

    // Carrega dados do servidor
    async function load() {
      const res = await fetch(WEB_APP_URL,{cache:'no-store'});
      const data = await res.json();
      if (data.error) throw new Error(data.message || 'Falha ao carregar');
      raw = data;
      document.getElementById('updated').textContent = new Date(data.generatedAt).toLocaleString('pt-BR');
      mountEmpresaOptions();
      // Default: primeira empresa + mês atual
      const first = raw.companies?.[0]?.company || '';
      document.getElementById('empresa').value = first;
      const now = new Date();
      document.getElementById('dtIni').valueAsDate = new Date(now.getFullYear(), now.getMonth(), 1);
      document.getElementById('dtFim').valueAsDate = new Date(now.getFullYear(), now.getMonth()+1, 0);
      render();
    }

    function mountEmpresaOptions(){
      const sel = document.getElementById('empresa');
      sel.innerHTML = (raw.companies||[]).map(c=>`<option>${escapeHtml(c.company)}</option>`).join('');
      sel.onchange = render;
      document.getElementById('dtIni').onchange = render;
      document.getElementById('dtFim').onchange = render;
      document.getElementById('busca').oninput = render;
    }

    function getFilters(){
      return {
        company: document.getElementById('empresa').value,
        dtIni: document.getElementById('dtIni').value,
        dtFim: document.getElementById('dtFim').value,
        q: document.getElementById('busca').value.trim().toLowerCase()
      };
    }

    function applyFilters(f){
      if (!raw) return [];
      current = raw.companies.find(c=>c.company===f.company) || raw.companies[0];
      if (!current) return [];

      const dtIni = f.dtIni ? new Date(f.dtIni) : null;
      const dtFim = f.dtFim ? new Date(f.dtFim) : null;

      const rows = (current.items||[]).filter(it=>{
        let ok = true;
        if (dtIni) ok = ok && it.data && new Date(it.data) >= dtIni;
        if (dtFim) ok = ok && it.data && new Date(it.data) <= new Date(dtFim.getFullYear(), dtFim.getMonth(), dtFim.getDate(), 23,59,59);
        if (f.q){
          const text = (it.historico+' '+it.complemento).toLowerCase();
          ok = ok && text.includes(f.q);
        }
        return ok;
      });
      return rows;
    }

    function render(){
      const f = getFilters();
      const rows = applyFilters(f);

      const entradas = rows.reduce((s,r)=>s+(r.entrada||0),0);
      const saidas   = rows.reduce((s,r)=>s+(r.saida||0),0);
      const saldoPeriodo = (current?.saldoImplantacao||0) + entradas - saidas;

      setKpi('kpi-saldo-impl', current?.saldoImplantacao||0, 'warn');
      setKpi('kpi-entradas', entradas, 'ok');
      setKpi('kpi-saidas',   saidas,   'bad');
      setKpi('kpi-saldo',    saldoPeriodo, saldoPeriodo>=0?'ok':'bad');

      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.data?new Date(r.data).toLocaleDateString('pt-BR'):''}</td>
          <td>${escapeHtml(r.historico||'')}</td>
          <td>${escapeHtml(r.complemento||'')}</td>
          <td class="right">${r.entrada?fmt.format(r.entrada):''}</td>
          <td class="right">${r.saida?fmt.format(r.saida):''}</td>
        </tr>
      `).join('');
      document.getElementById('empty').hidden = rows.length>0;
      document.getElementById('ttl').textContent = `Livro de Caixa — ${current?.company||''}`;
    }

    function setKpi(id,val,cls){
      const el=document.getElementById(id);
      el.classList.remove('ok','bad','warn');
      if(cls) el.classList.add(cls);
      el.querySelector('.value').textContent = fmt.format(val||0);
    }

    function escapeHtml(s){
      return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // ====== Sincronização com a janela principal via postMessage ======
    // 1) Lê filtros passados por querystring (company, dtIni, dtFim, q)
    function readQs(){
      const p = new URLSearchParams(location.search);
      const company = p.get('company');
      const dtIni = p.get('dtIni');
      const dtFim = p.get('dtFim');
      const q = p.get('q');
      if (company) document.getElementById('empresa').value = company;
      if (dtIni) document.getElementById('dtIni').value = dtIni;
      if (dtFim) document.getElementById('dtFim').value = dtFim;
      if (q) document.getElementById('busca').value = decodeURIComponent(q);
    }

    // 2) Recebe atualizações do index.html
    window.addEventListener('message', (evt)=>{
      const { type, payload } = evt.data||{};
      if (type === 'livrocaixa-filters'){
        if (payload.company) document.getElementById('empresa').value = payload.company;
        if (payload.dtIni) document.getElementById('dtIni').value = payload.dtIni;
        if (payload.dtFim) document.getElementById('dtFim').value = payload.dtFim;
        document.getElementById('busca').value = payload.q||'';
        render();
      }
    });

    // Inicializa
    load().then(()=>{ readQs(); render(); }).catch(err=>{
      alert('Erro ao carregar: '+err.message);
      console.error(err);
    });
  </script>
</body>
</html>
