<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Unificado • Dark</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0a0a0a;--panel:#111111;--soft:#161616;--ink:#f5f7ff;--muted:#a9b0c2;
      --primary:#00d1ff;--accent:#ff2e88;--ok:#37d399;--warn:#fec84b;--danger:#f43f5e;
      --card-radius:18px;--shadow:0 10px 40px rgba(0,0,0,.45)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(1100px 720px at 65% -10%, rgba(0,209,255,.12), transparent 60%),
        radial-gradient(900px 540px at -10% 15%, rgba(255,46,136,.10), transparent 55%),
        var(--bg);
      color:var(--ink)
    }
    .wrap{max-width:1500px;margin:32px auto;padding:0 24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
    .title{font-size:28px;font-weight:700}
    .subtitle{color:var(--muted);font-size:14px}
    .controls{display:flex;gap:12px;align-items:center}
    .btn,select{background:var(--panel);border:1px solid #1f1f1f;color:var(--ink);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow)}
    .btn:hover{filter:brightness(1.08)} select{appearance:none}

    /* módulos */
    .modules{display:grid;gap:18px;grid-template-columns:repeat(4,1fr)}
    .mod{position:relative;display:block;text-decoration:none;color:inherit;background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)),var(--panel);border:1px solid #1e1e1e;border-radius:var(--card-radius);padding:18px;box-shadow:var(--shadow);cursor:pointer;transition:transform .2s ease}
    .mod:hover{transform:translateY(-2px)}
    .mod h4{margin:0 0 6px;font-size:16px;font-weight:700}
    .mod .desc{color:var(--muted);font-size:12px}
    .mod .kpi{font-size:26px;font-weight:800;margin-top:10px;min-height:32px}
    .mod .foot{color:var(--muted);font-size:12px;margin-top:6px}
    .spark{width:100%;height:54px;margin-top:10px}
    .badge{position:absolute;top:12px;right:12px;background:var(--soft);border:1px solid #222;padding:6px 10px;border-radius:999px;font-size:12px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#0f0f0f;border:1px solid #1e1e1e;padding:6px 10px;border-radius:999px;font-size:12px}
    .chip i{width:8px;height:8px;border-radius:999px;background:var(--primary)}

    .grid{display:grid;gap:18px;grid-template-columns:repeat(3,1fr);margin-top:22px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)),var(--panel);border:1px solid #1c1c1c;border-radius:var(--card-radius);padding:16px 18px;box-shadow:var(--shadow);position:relative}
    .card h3{margin:0 0 4px;font-size:14px;font-weight:600;color:var(--muted)}
    .kpi-line{display:flex;align-items:center;justify-content:space-between}
    .kpi-value{font-size:28px;font-weight:700;min-height:34px}
    .pill{font-size:12px;color:#0a0a0a;background:var(--primary);padding:4px 8px;border-radius:999px;font-weight:700}

    .charts{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin-top:18px}
    .chart-card{padding:18px}
    canvas{width:100%;height:100%}

    /* loader + toast */
    .spinner{width:16px;height:16px;border:2px solid #2a2a2a;border-top-color:var(--primary);border-radius:50%;display:inline-block;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .overlay{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35)}
    .overlay.show{display:grid}
    .toast{position:fixed;right:18px;bottom:18px;background:#111;border:1px solid #2a2a2a;color:var(--ink);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);display:none;z-index:9999}
    .toast.show{display:block;animation:fadeIn .15s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    /* modal + loader */
    .modal-backdrop{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:999}
    .modal-backdrop.show{display:grid}
    .modal{width:min(1200px,92vw);height:min(86vh,900px);display:flex;flex-direction:column;background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)),var(--panel);border:1px solid #1e1e1e;border-radius:22px;box-shadow:var(--shadow)}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #1f1f1f;background:rgba(17,17,17,.9)}
    .modal .close{appearance:none;border:1px solid #2a2a2a;background:#0f0f0f;color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer}
    .modal .frame-wrap{flex:1;position:relative}
    .modal iframe{position:absolute;inset:0;width:100%;height:100%;border:0;border-bottom-left-radius:22px;border-bottom-right-radius:22px;background:#0b0b0b}
    .modal .loading{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.25)}
    .modal .loading.hidden{display:none}

    @media (max-width:1280px){.modules{grid-template-columns:repeat(3,1fr)}.charts{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Dashboard Unificado</div>
        <div class="subtitle">Versão Desktop • Paleta do print preto (ciano/rosa)</div>
      </div>
      <div class="controls">
        <select id="empresa">
          <option value="TODAS" selected>Todas as empresas</option>
          <option>MERCATTO DELICIA</option>
          <option>DELICIA GOURMET</option>
          <option>PADARIA DELICIA</option>
          <option>VILLA GOURMET</option>
          <option>M. KIDS</option>
        </select>
        <input type="month" id="periodo" class="btn" />
        <button class="btn" id="btn-refresh">Atualizar</button>
      </div>
    </header>

    <!-- Módulos -->
    <section class="modules">
      <a class="mod" role="button" tabindex="0" data-page="./index.metas.html"><span class="badge">Metas</span><h4>Metas</h4><div class="desc">Faturamento vs. objetivo</div><div class="kpi" id="m1">—</div><canvas class="spark" id="sp1"></canvas><div class="foot"><span class="chip"><i></i> Progresso</span></div></a>
      <a class="mod" role="button" tabindex="0" data-page="./index.cancelamentos.html"><span class="badge">Cancelamentos</span><h4>Cancelamentos</h4><div class="desc">Itens/valor cancelado</div><div class="kpi" id="m2">—</div><canvas class="spark" id="sp2"></canvas><div class="foot"><span class="chip"><i style="background:var(--danger)"></i> Risco</span></div></a>
      <a class="mod" role="button" tabindex="0" data-page="./index.travas.html"><span class="badge">Travas</span><h4>Travas de Compras</h4><div class="desc">Planos válidos e já comprado</div><div class="kpi" id="m3">—</div><canvas class="spark" id="sp3"></canvas><div class="foot"><span class="chip"><i style="background:var(--warn)"></i> Alerta</span></div></a>
      <a class="mod" role="button" tabindex="0" data-page="./index.caixas.html"><span class="badge">Financeiro</span><h4>Resumo Financeiro</h4><div class="desc">Entradas x Saídas</div><div class="kpi" id="m4">—</div><canvas class="spark" id="sp4"></canvas><div class="foot"><span class="chip"><i style="background:var(--ok)"></i> Saldo</span></div></a>
      <a class="mod" role="button" tabindex="0" data-page="./index.delivery.html"><span class="badge">Delivery</span><h4>Vendas em Delivery</h4><div class="desc">Pedidos / ticket médio</div><div class="kpi" id="m5">—</div><canvas class="spark" id="sp5"></canvas><div class="foot"><span class="chip"><i></i> Crescimento</span></div></a>
      <a class="mod" role="button" tabindex="0" data-page="./index.conciliacao.html"><span class="badge">Bancária</span><h4>Conciliação Bancária</h4><div class="desc">Conferência de movimentos</div><div class="kpi" id="m6">—</div><canvas class="spark" id="sp6"></canvas><div class="foot"><span class="chip"><i style="background:var(--accent)"></i> Pendências</span></div></a>
      <a class="mod" role="button" tabindex="0" data-page="./index.nps.html"><span class="badge">NPS</span><h4>Pesquisa de Satisfação</h4><div class="desc">NPS / avaliações</div><div class="kpi" id="m7">—</div><canvas class="spark" id="sp7"></canvas><div class="foot"><span class="chip"><i style="background:var(--ok)"></i> Pontuação</span></div></a>
      <a class="mod" role="button" tabindex="0" data-page="./index.midias.html"><span class="badge">Mídias</span><h4>Mídias Sociais</h4><div class="desc">Views / engajamento</div><div class="kpi" id="m8">—</div><canvas class="spark" id="sp8"></canvas><div class="foot"><span class="chip"><i style="background:var(--accent)"></i> Engaj.</span></div></a>
    </section>

    <!-- Card Saldo -->
    <section class="grid" style="margin-top:22px">
      <div class="card card-click" id="card-saldo" role="button" tabindex="0" data-page="./index.caixas.html">
        <div class="overlay" id="card-loader"><div><span class="spinner"></span> Carregando…</div></div>
        <h3>Saldo na Loja (mês)</h3>
        <div class="kpi-line">
          <div class="kpi-value" id="kpi-saldo">—</div>
          <span class="pill">Detalhar</span>
        </div>
        <div class="subtitle" id="lbl-periodo" style="margin-top:6px;color:var(--muted);font-size:12px">—</div>
      </div>
      <div class="card"><h3>Máquinas Stone</h3><div class="kpi-line"><div class="kpi-value">—</div><span class="pill" style="background:var(--accent)">Ativos</span></div></div>
      <div class="card"><h3>Requisições</h3><div class="kpi-line"><div class="kpi-value">—</div><span class="pill" style="background:var(--ok)">Créditos</span></div></div>
    </section>

    <!-- Charts decorativos -->
    <section class="charts">
      <div class="card chart-card"><h3>Timeline geral</h3><canvas id="line-timeline" height="300"></canvas></div>
      <div class="card chart-card"><h3>Dias mais ativos</h3><canvas id="bar-days" height="300"></canvas></div>
    </section>

    <div class="subtitle" style="margin-top:16px">Última atualização: <span id="last-update">—</span></div>
  </div>

  <!-- Modal com IFRAME -->
  <div id="modal-backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <header>
        <h2 id="modal-title">Abrindo…</h2>
        <button class="close" id="modal-close" aria-label="Fechar (Esc)">✕</button>
      </header>
      <div class="frame-wrap">
        <div id="modal-loading" class="loading"><span class="spinner"></span></div>
        <iframe id="modal-frame" src="about:blank" title="Conteúdo"></iframe>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ================= CONFIG ================= */
const CONFIG = {
  APIS: {
    // Cole aqui a URL /exec do seu Apps Script:
    FINANCEIRO: 'https://script.google.com/macros/s/AKfycbwZkSRi2ZX5gZYqomDaYmXQVsh2cUBUq6SYebBdhDg0a0NPe48zNsIsUKdyPBBo2wNLYQ/exec'
  }
};

/* ================= HELPERS ================= */
const $ = s => document.querySelector(s);
const fmtBRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});

function spark(el,data){
  const ctx=document.getElementById(el); if(!ctx) return;
  const g=ctx.getContext('2d').createLinearGradient(0,0,0,60);
  g.addColorStop(0,'rgba(0,209,255,.35)'); g.addColorStop(1,'rgba(255,46,136,.05)');
  try{
    new Chart(ctx,{type:'line',data:{labels:data.map((_,i)=>i+1),datasets:[{data,borderWidth:2,pointRadius:0,tension:.35,fill:true,backgroundColor:g,borderColor:'#00d1ff'}]},options:{plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}});
  }catch(e){ console.warn('Spark falhou', e); }
}
function bootCharts(){
  try{
    new Chart($('#line-timeline'),{type:'line',data:{labels:['S1','S2','S3','S4','S5','S6','S7'],datasets:[{label:'Likes',data:[180,220,260,300,450,200,150],tension:.35,borderWidth:2,pointRadius:0,borderColor:'#00d1ff'},{label:'Novos seguidores',data:[60,120,180,250,380,150,90],tension:.35,borderWidth:2,pointRadius:0,borderColor:'#ff2e88'}]}});
    new Chart($('#bar-days'),{type:'bar',data:{labels:['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'],datasets:[{label:'Eventos',data:[16,8,11,16,9,8,7],backgroundColor:'#00d1ff'}]}});
  }catch(e){ console.warn('Charts falharam', e); }
}
function showToast(msg){const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),4500);}

function showCardLoader(on){ $('#card-loader').classList.toggle('show', !!on); }
function setBtnLoading(on){
  const b=$('#btn-refresh');
  if(on){ b.disabled=true; b.dataset.prev=b.textContent; b.textContent='Carregando…'; }
  else  { b.disabled=false; b.textContent=b.dataset.prev||'Atualizar'; }
}

function buildUrl(base,empresa,periodo){
  if(!base) throw new Error('API FINANCEIRO não configurada');
  const u=new URL(base);
  if(empresa && empresa!=='TODAS') u.searchParams.set('empresa',empresa);
  if(periodo) u.searchParams.set('periodo',periodo);
  return u.toString();
}
async function fetchJSON(url){
  const r = await fetch(url,{headers:{'cache-control':'no-cache'}});
  const txt = await r.text();
  try { return JSON.parse(txt); } catch(e){ console.error('Resposta não JSON:', txt); throw new Error('A API não retornou JSON'); }
}

/* ================= CORE ================= */
async function loadSaldoCard(){
  const empresa = $('#empresa').value;
  const periodo = $('#periodo').value || new Date().toISOString().slice(0,7);
  $('#lbl-periodo').textContent = `Período: ${periodo.split('-').reverse().join('/')}`;

  showCardLoader(true); setBtnLoading(true);
  try{
    const data = await fetchJSON(buildUrl(CONFIG.APIS.FINANCEIRO, empresa, periodo));
    if(data.ok === false) throw new Error(data.error||'Falha no Apps Script');
    $('#kpi-saldo').textContent = fmtBRL.format(Number(data.saldoLoja||0)); // E4
  }catch(err){
    console.error(err);
    $('#kpi-saldo').textContent = '—';
    showToast('Erro ao carregar saldo: '+err.message);
  }finally{
    showCardLoader(false); setBtnLoading(false);
  }
}

/* ================= MODAL (IFRAME) ================= */
async function openModal(pageTitle, pagePath){
  try{
    // verificação rápida: o arquivo existe?
    const headResp = await fetch(pagePath, {method:'HEAD'});
    if(!headResp.ok){ showToast('Arquivo não encontrado: '+pagePath); return; }
  }catch(e){
    console.warn('HEAD falhou, tentando assim mesmo…', e);
  }

  const empresa = encodeURIComponent($('#empresa').value);
  const periodo = encodeURIComponent($('#periodo').value || new Date().toISOString().slice(0,7));

  const frame = $('#modal-frame');
  $('#modal-title').textContent = pageTitle || 'Detalhes';
  $('#modal-loading').classList.remove('hidden');
  frame.src = `${pagePath}?empresa=${empresa}&periodo=${periodo}`;

  const b = $('#modal-backdrop');
  b.classList.add('show'); b.setAttribute('aria-hidden','false');

  frame.onload = ()=>$('#modal-loading').classList.add('hidden');
  // não existe onerror confiável em iframe; usar timeout para exibir aviso se travar
  setTimeout(()=>{ 
    if($('#modal-backdrop').classList.contains('show') && !$('#modal-loading').classList.contains('hidden')){
      $('#modal-loading').classList.add('hidden');
      showToast('Não foi possível carregar o conteúdo.');
    }
  }, 6000);
}
function closeModal(){
  const b = $('#modal-backdrop');
  b.classList.remove('show');
  b.setAttribute('aria-hidden','true');
  $('#modal-frame').src = 'about:blank';
}

/* ================= BOOT ================= */
document.addEventListener('DOMContentLoaded', ()=>{
  // mês atual padrão com fallback para navegadores antigos
  const ymNow = new Date().toISOString().slice(0,7);
  const monthInput = $('#periodo');
  try{ monthInput.value = ymNow; }catch{ monthInput.setAttribute('value', ymNow); }
  $('#last-update').textContent = new Date().toLocaleString('pt-BR');

  // sparks decorativos
  ['sp1','sp2','sp3','sp4','sp5','sp6','sp7','sp8'].forEach(id=>{
    spark(id, Array.from({length:12},()=>100+Math.random()*300));
  });
  bootCharts();

  // primeira carga do saldo
  loadSaldoCard();

  // eventos
  $('#btn-refresh').addEventListener('click', loadSaldoCard);
  $('#empresa').addEventListener('change', loadSaldoCard);
  $('#periodo').addEventListener('change', loadSaldoCard);

  // abrir modal ao clicar no card de saldo
  $('#card-saldo').addEventListener('click', ()=>openModal('Livro de Caixa', './index.caixas.html'));

  // abrir modal ao clicar em QUALQUER módulo (usa data-page)
  document.addEventListener('click', (ev)=>{
    const el = ev.target.closest('.mod');
    if(!el) return;
    const page = el.getAttribute('data-page') || './index.caixas.html';
    const title = el.querySelector('h4')?.textContent?.trim() || 'Detalhes';
    openModal(title, page);
  });

  // fechar modal
  $('#modal-close').addEventListener('click', closeModal);
  $('#modal-backdrop').addEventListener('click', (e)=>{ if(e.target.id==='modal-backdrop') closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
});

// Captura erros JS globais para facilitar debug e não derrubar o restante
window.addEventListener('error', (e)=>{
  console.error('Erro JS:', e.message, e.filename, e.lineno);
  showToast('Erro na página: ' + e.message);
});
</script>
</body>
</html>
