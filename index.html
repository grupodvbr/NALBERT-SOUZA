<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Unificado</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{ --bg:#0a0a0a; --panel:#111111; --soft:#161616; --ink:#f5f7ff; --muted:#a9b0c2; --primary:#00d1ff; --accent:#ff2e88; --ok:#37d399; --warn:#fec84b; --danger:#f43f5e; --card-radius:18px; --shadow:0 10px 40px rgba(0,0,0,.45); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:var(--ink);
      background:
        radial-gradient(1100px 720px at 65% -10%, rgba(0,209,255,.12), transparent 60%),
        radial-gradient(900px 540px at -10% 15%, rgba(255,46,136,.10), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1500px;margin:32px auto;padding:0 24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
    .title{font-size:28px;font-weight:700;letter-spacing:.3px}
    .subtitle{color:var(--muted);font-size:14px}
    .controls{display:flex;gap:12px;align-items:center}
    .btn, select, input[type="month"]{background:var(--panel);border:1px solid #1f1f1f;color:var(--ink);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow)}
    .btn:hover{filter:brightness(1.08)}
    select{appearance:none}

    .modules{display:grid;gap:18px;grid-template-columns:repeat(4,1fr)}
    .mod{
      position:relative;display:block;text-decoration:none;color:inherit;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)),var(--panel);
      border:1px solid #1e1e1e;border-radius:var(--card-radius);padding:18px;box-shadow:var(--shadow);
      overflow:hidden;cursor:pointer;transition:transform .2s ease, filter .2s ease
    }
    .mod:hover{transform:translateY(-2px);filter:brightness(1.02)}
    .mod h4{margin:0 0 6px;font-size:16px;font-weight:700}
    .mod .desc{color:var(--muted);font-size:12px}
    .mod .kpi{font-size:24px;font-weight:800;margin-top:10px;line-height:1.35}
    .mod .foot{color:var(--muted);font-size:12px;margin-top:6px}
    .spark{width:100%;height:54px;margin-top:10px}
    .badge{position:absolute;top:12px;right:12px;background:var(--soft);border:1px solid #222;padding:6px 10px;border-radius:999px;font-size:12px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#0f0f0f;border:1px solid #1e1e1e;padding:6px 10px;border-radius:999px;font-size:12px}
    .chip i{width:8px;height:8px;border-radius:999px;background:var(--primary)}

    .grid{display:grid;gap:18px;grid-template-columns:repeat(3,1fr);margin-top:22px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)), var(--panel);
      border:1px solid #1c1c1c;border-radius:var(--card-radius);padding:16px 18px;box-shadow:var(--shadow);
      position:relative;overflow:hidden;cursor:pointer
    }
    .card h3{margin:0 0 4px;font-size:14px;font-weight:600;color:var(--muted)}
    .kpi-line{display:flex;align-items:center;justify-content:space-between}
    .kpi-value{font-size:28px;font-weight:700}
    .pill{font-size:12px;color:#0a0a0a;background:var(--primary);padding:4px 8px;border-radius:999px;font-weight:700}

    .charts{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin-top:18px}
    .chart-card{padding:18px}
    canvas{width:100%;height:100%}

    /* ===== Card Metas — UI bonita e compacta ===== */
    #kpi-metas{font-size:13px;line-height:1.35;font-weight:600}
    #kpi-metas .meta-head{font-size:12px;color:var(--muted);margin-bottom:6px}


    .meta-list {
  overflow: visible;
  max-height: none;
}
    
   .meta-item {
  background: var(--panel); /* volta para o fundo escuro original */
  border: 1px solid #1f1f1f;
  border-radius: 12px;
  padding: 20px 12px;
  min-height: 100px;
}
    .meta-top{display:flex;justify-content:space-between;gap:10px;font-weight:700;margin-bottom:6px}
    .meta-name{color:#e8ecf9;letter-spacing:.2px;max-width:60%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .meta-val{color:#e9efff;white-space:nowrap}
    .meta-sub{display:flex;align-items:center;gap:10px;justify-content:space-between;font-size:12px;color:var(--muted)}
    .progress{flex:1;height:7px;background:#151515;border-radius:999px;overflow:hidden;box-shadow:inset 0 0 0 1px #1d1d1d}
    .progress>i{display:block;height:100%;width:var(--w,0%);background:linear-gradient(90deg,var(--primary),#46e0ff);border-radius:999px}
    .badge-mini{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid #1f1f1f;background:#0c0c0c;color:#cfd6e6;margin-left:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Dashboard Unificado</div>
        <div class="subtitle">Versão Desktop • Paleta do print preto (ciano/rosa)</div>
      </div>
      <div class="controls">
        <select id="empresa">
          <option value="TODAS">Todas as empresas</option>
          <option>MERCATTO DELICIA</option>
          <option>DELICIA GOURMET</option>
          <option>PADARIA DELICIA</option>
          <option>VILLA GOURMET</option>
          <option>M. KIDS</option>
        </select>
        <input type="month" id="periodo" />
        <button class="btn" id="btn-refresh">Atualizar</button>
      </div>
    </header>

    <!-- Módulos -->
    <section class="modules">
      <a class="mod" data-mod="METAS" id="link-metas" href="#">
        <span class="badge">Metas</span>
        <h4>Metas</h4>
        <div class="desc">Faturamento vs. objetivo</div>
        <div class="kpi" id="kpi-metas">—</div>
        <canvas id="spark-metas" class="spark"></canvas>
        <div class="foot"><span class="chip"><i></i> Progresso</span></div>
      </a>

      <a class="mod" data-mod="CANCELAMENTOS" id="link-cancel" href="#">
        <span class="badge">Cancelamentos</span>
        <h4>Cancelamentos</h4>
        <div class="desc">Itens/valor cancelado</div>
        <div class="kpi" id="kpi-cancel">—</div>
        <canvas id="spark-cancel" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--danger)"></i> Risco</span></div>
      </a>

      <a class="mod" data-mod="TRAVAS" id="link-travas" href="#">
        <span class="badge">Travas</span>
        <h4>Travas de Compras</h4>
        <div class="desc">Planos válidos e já comprado</div>
        <div class="kpi" id="kpi-travas">—</div>
        <canvas id="spark-travas" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--warn)"></i> Alerta</span></div>
      </a>

      <a class="mod" data-mod="FINANCEIRO" id="link-fin" href="#">
        <span class="badge">Financeiro</span>
        <h4>Resumo Financeiro</h4>
        <div class="desc">Entradas x Saídas</div>
        <div class="kpi" id="kpi-fin">—</div>
        <canvas id="spark-fin" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--ok)"></i> Saldo</span></div>
      </a>

      <a class="mod" data-mod="DELIVERY" id="link-delivery" href="#">
        <span class="badge">Delivery</span>
        <h4>Vendas em Delivery</h4>
        <div class="desc">Bruto / plataformas</div>
        <div class="kpi" id="kpi-delivery">—</div>
        <canvas id="spark-delivery" class="spark"></canvas>
        <div class="foot"><span class="chip"><i></i> Crescimento</span></div>
      </a>

      <a class="mod" data-mod="CONCILIACAO" id="link-bank" href="#">
        <span class="badge">Bancária</span>
        <h4>Conciliação Bancária</h4>
        <div class="desc">Conferência de movimentos</div>
        <div class="kpi" id="kpi-bank">—</div>
        <canvas id="spark-bank" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--accent)"></i> Pendências</span></div>
      </a>

      <a class="mod" data-mod="PESQUISA" id="link-nps" href="#">
        <span class="badge">NPS</span>
        <h4>Pesquisa de Satisfação</h4>
        <div class="desc">NPS / avaliações</div>
        <div class="kpi" id="kpi-nps">—</div>
        <canvas id="spark-nps" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--ok)"></i> Pontuação</span></div>
      </a>

      <a class="mod" data-mod="ABC" id="link-abc" href="#">
        <span class="badge">ABC</span>
        <h4>ABC de Vendas</h4>
        <div class="desc">Faturamento / lucro</div>
        <div class="kpi" id="kpi-abc">—</div>
        <canvas id="spark-abc" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--accent)"></i> Destaque</span></div>
      </a>
    </section>

    <!-- KPIs gerais -->
    <section class="grid">
      <div class="card" id="card-periodo">
        <h3>Período</h3>
        <div class="kpi-line"><div class="kpi-value" id="kpi-competencia">—</div><span class="pill">Abrir Pop-up</span></div>
      </div>
      <div class="card"><h3>Máquinas Stone</h3><div class="kpi-line"><div class="kpi-value" id="kpi-func-ativos">—</div><span class="pill" style="background:var(--accent)">Ativos</span></div></div>
      <div class="card"><h3>Requisições</h3><div class="kpi-line"><div class="kpi-value" id="kpi-credito">—</div><span class="pill" style="background:var(--ok)">Créditos</span></div></div>
    </section>

    <!-- CHARTS -->
    <section class="charts">
      <div class="card chart-card"><h3>Timeline geral</h3><canvas id="line-timeline" height="300"></canvas></div>
      <div class="card chart-card"><h3>Dias mais ativos</h3><canvas id="bar-days" height="300"></canvas></div>
    </section>

    <div class="subtitle" style="margin-top:16px">Última atualização: <span id="last-update">—</span></div>
  </div>

<script>
/* ====== CONFIG (DADOS REAIS) ====== */
const CONFIG = {
  POPUP_URL: 'popup.html',
  API_URL: 'https://script.google.com/macros/s/AKfycbwITuNC_KBSCYJ5PGsFcQ5eW1JhdxzRkyX81AAcxHDFL_PWYMu11V3njjESvH-AmJpx/exec', // Financeiro
  METAS_URL: 'https://script.google.com/macros/s/AKfycbzyiL6yNCj_FYWiQ2PS88mthToCvWM1wJ0q7CQy8asyg-59L8YezKzFY6d-lgQU0ni3/exec',
  CANCEL_URL: 'https://script.google.com/macros/s/AKfycby6kNirWdyaFymip0MFrqTNoItMgqkXJrzwf41Qxe2P1j8BoBILtnyws8o4f5sUdg-T3w/exec',
  DELIVERY_URL: 'https://script.google.com/macros/s/AKfycby3tGjtsUXcak51bcWG175VU4SWT2RV6pA9vJLyQxlMXSt3bGJFoi2R0YmDmuwzbcbOnw/exec',
  AVAL_URL: 'https://script.google.com/macros/s/AKfycbyK3A5CDn_EgA3pbRVToh87_qKWvbIry886OkR1AdkJi7RyvSgcwY0BmRqhbKQnEKwgrA/exec',
  ABC_URL: 'https://script.google.com/macros/s/AKfycbz8NEPUpDI0_JZKeqQLrV4JwinN1RVGDs7-a0Rc3lWidxJa4GRin4csMkceAs5XjVOpOg/exec'
};
const $ = s => document.querySelector(s);

/* ====== HELPERS ====== */
const fmtBR = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
function toNumber(v){
  if(v==null) return 0;
  if(typeof v === 'number') return v;
  return Number(String(v).replace(/[^0-9,-]/g,'').replace(/\./g,'').replace(',', '.')) || 0;
}
function buildUrl(base, params){
  const u = new URL(base);
  Object.entries(params||{}).forEach(([k,v])=>{ if(v!=null && v!=='') u.searchParams.set(k,v); });
  return u.toString();
}
function yyyymm(dt){ return (dt||'').slice(0,7); }
function isSameMonth(iso, periodo){ return yyyymm(iso) === periodo; }
function byMonth(records, periodo, empresaSel, getEmpresa=(r)=>r.empresa||r.Empresa){
  return records.filter(r=>{
    const d = r.data || r.Data || r.DATA;
    const emp = getEmpresa(r);
    const okMonth = isSameMonth(d, periodo);
    const okEmp = (empresaSel==='TODAS') || (emp===empresaSel);
    return okMonth && okEmp;
  });
}
function sumBy(arr, f){ return arr.reduce((acc, r)=> acc + toNumber(f(r)), 0); }

/* ====== CHARTS (Financeiro principal) ====== */
let chartLine, chartBar;
function makeLine(ctx){ return new Chart(ctx,{
  type:'line',
  data:{ labels:[], datasets:[
    {label:'Entradas', data:[], tension:.35, borderWidth:2, pointRadius:0, borderColor:'#00d1ff'},
    {label:'Saídas',   data:[], tension:.35, borderWidth:2, pointRadius:0, borderColor:'#ff2e88'}
  ]},
  options:{ plugins:{legend:{labels:{color:'#9aa3b8'}}},
            scales:{x:{ticks:{color:'#8b93a7'}},y:{grid:{color:'rgba(255,255,255,.06)'}}} }
});}
function makeBar(ctx){ return new Chart(ctx,{
  type:'bar',
  data:{ labels:[], datasets:[{label:'Movimentos', data:[], backgroundColor:'#00d1ff'}] },
  options:{ plugins:{legend:{labels:{color:'#9aa3b8'}}},
            scales:{y:{grid:{color:'rgba(255,255,255,.06)'}}} }
});}

/* ====== POP-UP SYNC ====== */
let popupWin = null;
function currentFilters(){ return { company: $('#empresa').value, periodo: $('#periodo').value }; }
function openPopup(e){
  e && e.preventDefault && e.preventDefault();
  const qs = new URLSearchParams(currentFilters()).toString();
  const url = CONFIG.POPUP_URL + '?' + qs;
  const w = window.open(url, 'popup_livro_caixa', 'width=1200,height=800,menubar=no,toolbar=no,location=no');
  popupWin = w && !w.closed ? w : null;
  if(!popupWin) window.location.href = url; // fallback
}
function syncFiltersToPopup(){
  if(popupWin && !popupWin.closed){
    popupWin.postMessage({ type:'livrocaixa-filters', payload: currentFilters() }, '*');
  }
}

/* ====== FINANCEIRO (API REAL JÁ EXISTENTE) ====== */
async function fetchMovements(empresa, periodo){
  const url = buildUrl(CONFIG.API_URL, { action:'list', empresa, periodo });
  const r = await fetch(url, { cache:'no-store' });
  if(!r.ok) throw new Error('Falha ao carregar movimentos');
  const data = await r.json();
  return Array.isArray(data) ? data : (data.items || data.rows || []);
}
function summarize(rows){
  let entradas = 0, saidas = 0;
  const byDay = new Map();
  for(const it of rows){
    const d = (it.data || it.Data || '').slice(0,10);
    const key = d.includes('/') ? d.split('/').reverse().join('-') : d;
    const e = toNumber(it.entrada ?? it.Entrada);
    const s = toNumber(it.saida   ?? it.Saida);
    entradas += e; saidas += s;
    if(!byDay.has(key)) byDay.set(key,{e:0,s:0});
    byDay.get(key).e += e; byDay.get(key).s += s;
  }
  const labels = [...byDay.keys()].sort();
  const serieE = labels.map(k=> byDay.get(k).e);
  const serieS = labels.map(k=> byDay.get(k).s);
  return { entradas, saidas, labels, serieE, serieS, saldo: entradas - saidas };
}

/* ====== METAS — lista por empresa com barra de progresso ====== */
async function loadMetas(){
  const empresaSel = $('#empresa').value;
  const periodo = $('#periodo').value; // YYYY-MM
  try{
    const r = await fetch(CONFIG.METAS_URL, { cache:'no-store' });
    const data = await r.json();

    const rows = data.filter(it=>{
      const dt = (it.Data || it.data || '').slice(0,10);
      const emp = it.Empresa || it.empresa;
      return dt.startsWith(periodo) && (empresaSel==='TODAS' || emp===empresaSel);
    });
    if(!rows.length){ $('#kpi-metas').textContent='—'; return; }

    const latest = {};
    rows.forEach(it=>{
      const emp = (it.Empresa || it.empresa || '').trim();
      const dt  = (it.Data || it.data || '').slice(0,10);
      if(!latest[emp] || dt > latest[emp].dt){
        latest[emp] = { dt, previsto: toNumber(it.Previsto), realizado: toNumber(it.Realizado) };
      }
    });

    const items = Object.entries(latest).sort(([a],[b])=>a.localeCompare(b)).map(([emp, v])=>{
      const perc = v.previsto>0 ? (v.realizado/v.previsto)*100 : 0;
      const status =
        perc>=100 ? '<span class="badge-mini" style="color:#7fffb4;border-color:#1f3b2f">OK</span>' :
        perc>=70  ? '<span class="badge-mini" style="color:#ffe08a;border-color:#3b341f">Andamento</span>' :
                    '<span class="badge-mini" style="color:#ff9aaa;border-color:#3b1f26">Atenção</span>';
      return `
        <li class="meta-item">
          <div class="meta-top">
            <div class="meta-name">${emp}</div>
            <div class="meta-val">${fmtBR.format(v.previsto)}</div>
          </div>
          <div class="meta-sub">
            <div class="progress" style="--w:${perc.toFixed(1)}%"><i></i></div>
            <div>${perc.toFixed(1)}% <span style="color:#cfe9ff">(${fmtBR.format(v.realizado)})</span> ${status}</div>
          </div>
        </li>`;
    }).join('');

    const [y,m] = periodo.split('-');
    const head = `<div class="meta-head">${m}/${y} • ${empresaSel==='TODAS' ? 'Grupo' : empresaSel}</div>`;
    $('#kpi-metas').innerHTML = head + `<ul class="meta-list">${items}</ul>`;
  }catch(e){
    console.error('Metas erro', e);
    $('#kpi-metas').textContent='—';
  }
}

/* ====== CANCELAMENTOS ====== */
async function loadCancel(){
  const empresaSel = $('#empresa').value;
  const periodo = $('#periodo').value;
  try{
    const r = await fetch(CONFIG.CANCEL_URL, { cache:'no-store' });
    const data = await r.json();
    const filtrados = byMonth(data, periodo, empresaSel, r=>r.empresa);
    const total = sumBy(filtrados, r=>r.valor);
    const byDay = {};
    filtrados.forEach(c=>{ byDay[c.data]=(byDay[c.data]||0)+toNumber(c.valor); });
    let picoData='—', picoVal=0;
    Object.keys(byDay).forEach(d=>{ if(byDay[d]>picoVal){picoVal=byDay[d]; picoData=d;} });
    const picoFmt = picoData!=='—' ? picoData.split('-').reverse().join('/') : '—';
    $('#kpi-cancel').innerHTML = `${fmtBR.format(total)}<div style="font-size:12px;color:var(--muted)">Pico: ${picoFmt} (${fmtBR.format(picoVal)})</div>`;
  }catch(e){ console.error('Cancel erro', e); $('#kpi-cancel').textContent='—'; }
}

/* ====== DELIVERY ====== */
async function loadDelivery(){
  const empresaSel = $('#empresa').value;
  const periodo = $('#periodo').value;
  try{
    const r = await fetch(CONFIG.DELIVERY_URL, { cache:'no-store' });
    const data = await r.json();
    const filtrados = byMonth(data, periodo, empresaSel, r=>r.empresa);
    const brutoTotal = sumBy(filtrados, r=>r.bruto);
    const byPlat = {};
    filtrados.forEach(d=>{ const k=d.plataforma; byPlat[k]=(byPlat[k]||0)+toNumber(d.bruto); });
    let topPlat='—', topVal=0;
    Object.entries(byPlat).forEach(([k,v])=>{ if(v>topVal){topVal=v; topPlat=k;} });
    $('#kpi-delivery').innerHTML = `${fmtBR.format(brutoTotal)}<div style="font-size:12px;color:var(--muted)">Top: ${topPlat} (${fmtBR.format(topVal)})</div>`;
  }catch(e){ console.error('Delivery erro', e); $('#kpi-delivery').textContent='—'; }
}

/* ====== NPS ====== */
const notasMap = { 'Ruim':1, 'Bom':2, 'Boa':2, 'Boas':2, 'Ótimo':3, 'Ótimas':3 };
function notaCampo(a, campo){ return notasMap[(a[campo]||'').trim()]||0; }
async function loadNPS(){
  const empresaSel = $('#empresa').value;
  const periodo = $('#periodo').value;
  try{
    const r = await fetch(CONFIG.AVAL_URL, { cache:'no-store' });
    const data = await r.json();
    const filtrados = byMonth(data, periodo, empresaSel, r=>r.empresa);
    const total = filtrados.length;
    const medias = ['ambiente','iluminacao','comida','musica','atendimento'].map(c=>{
      const arr = filtrados.map(a=>notaCampo(a,c)).filter(n=>n>0);
      return arr.length ? (arr.reduce((s,n)=>s+n,0)/arr.length) : 0;
    });
    const notaGeral = medias.length? (medias.reduce((s,n)=>s+n,0)/medias.length) : 0;
    $('#kpi-nps').innerHTML = `${total} avaliações<div style="font-size:12px;color:var(--muted)">Nota geral: ${notaGeral.toFixed(2)} / 3</div>`;
  }catch(e){ console.error('NPS erro', e); $('#kpi-nps').textContent='—'; }
}

/* ====== ABC ====== */
async function loadABC(){
  const empresaSel = $('#empresa').value;
  const periodo = $('#periodo').value;
  try{
    const r = await fetch(CONFIG.ABC_URL, { cache:'no-store' });
    const data = await r.json();
    const filtrados = byMonth(data, periodo, empresaSel, r=>r.empresa);
    const faturamento = sumBy(filtrados, r=>r.faturamento);
    const lucro = sumBy(filtrados, r=>r.lucro);
    const byProd = {};
    filtrados.forEach(d=>{ byProd[d.produto]=(byProd[d.produto]||0)+toNumber(d.faturamento); });
    let topProd='—', topVal=0;
    Object.entries(byProd).forEach(([p,v])=>{ if(v>topVal){topVal=v; topProd=p;} });
    $('#kpi-abc').innerHTML = `${fmtBR.format(faturamento)}<div style="font-size:12px;color:var(--muted)">Lucro: ${fmtBR.format(lucro)} • Top: ${topProd}</div>`;
  }catch(e){ console.error('ABC erro', e); $('#kpi-abc').textContent='—'; }
}

/* ====== LOAD (DADOS REAIS) ====== */
async function loadIndex(){
  const empresa = $('#empresa').value;
  const periodo = $('#periodo').value;
  try{
    const rows = await fetchMovements(empresa, periodo);
    const s = summarize(rows);

    $('#kpi-competencia').textContent = periodo.split('-').reverse().join('/');
    const elFin = document.getElementById('kpi-fin');
    if(elFin) elFin.textContent = fmtBR.format(s.saldo);

    if(!chartLine) chartLine = makeLine(document.getElementById('line-timeline'));
    if(!chartBar)  chartBar  = makeBar(document.getElementById('bar-days'));

    chartLine.data.labels = s.labels.map(l=> l.split('-').reverse().join('/'));
    chartLine.data.datasets[0].data = s.serieE;
    chartLine.data.datasets[1].data = s.serieS;
    chartLine.update();

    chartBar.data.labels = chartLine.data.labels;
    chartBar.data.datasets[0].data = s.serieE.map((v,i)=> v + (s.serieS[i]||0));
    chartBar.update();

    await Promise.all([ loadMetas(), loadCancel(), loadDelivery(), loadNPS(), loadABC() ]);

    $('#last-update').textContent = new Date().toLocaleString('pt-BR');
  }catch(err){
    console.error(err);
    const elFin = document.getElementById('kpi-fin');
    if(elFin) elFin.textContent = '—';
  }
}

/* ====== INIT ====== */
function init(){
  const month = new Date().toISOString().slice(0,7);
  $('#periodo').value = month;
  $('#kpi-competencia').textContent = month.split('-').reverse().join('/');

  chartLine = makeLine(document.getElementById('line-timeline'));
  chartBar  = makeBar(document.getElementById('bar-days'));

  document.getElementById('card-periodo').addEventListener('click', openPopup);
  document.getElementById('btn-refresh').addEventListener('click', ()=>{ loadIndex(); syncFiltersToPopup(); });

  document.getElementById('empresa').addEventListener('change', ()=>{ loadIndex(); syncFiltersToPopup(); });
  document.getElementById('periodo').addEventListener('change', ()=>{ 
    $('#kpi-competencia').textContent = $('#periodo').value.split('-').reverse().join('/'); 
    loadIndex(); 
    syncFiltersToPopup(); 
  });

  loadIndex();
}
window.addEventListener('DOMContentLoaded', ()=>{ try{ init(); }catch(e){ console.error('Init error', e); } });
</script>
</body>
</html>
