<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Unificado • Dark</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      /* === PALETA (print preto ciano/rosa) === */
      --bg: #0a0a0a;
      --panel: #111111;
      --soft: #161616;
      --ink: #f5f7ff;
      --muted: #a9b0c2;
      --ring1: #00d1ff;
      --ring2: #ff2e88;
      --primary: #00d1ff;
      --accent: #ff2e88;
      --ok: #37d399;
      --warn: #fec84b;
      --danger: #f43f5e;
      --card-radius: 18px;
      --shadow: 0 10px 40px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1100px 720px at 65% -10%, rgba(0,209,255,.12), transparent 60%),
                  radial-gradient(900px 540px at -10% 15%, rgba(255,46,136,.10), transparent 55%),
                  var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:1500px;margin:32px auto;padding:0 24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
    .title{font-size:28px;font-weight:700;letter-spacing:.3px}
    .subtitle{color:var(--muted);font-size:14px}
    .controls{display:flex;gap:12px;align-items:center}
    .btn, select{background:var(--panel);border:1px solid #1f1f1f;color:var(--ink);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow)}
    .btn:hover{filter:brightness(1.08)}
    select{appearance:none}

    /* NAV de MÓDULOS */
    .modules{display:grid;gap:18px;grid-template-columns:repeat(4,1fr)}
    .mod{position:relative;display:block;text-decoration:none;color:inherit;background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)),var(--panel);border:1px solid #1e1e1e;border-radius:var(--card-radius);padding:18px;box-shadow:var(--shadow);overflow:hidden;cursor:pointer}
    .mod:hover{transform:translateY(-2px);transition:.2s ease;filter:brightness(1.02)}
    .mod h4{margin:0 0 6px;font-size:16px;font-weight:700}
    .mod .desc{color:var(--muted);font-size:12px}
    .mod .kpi{font-size:26px;font-weight:800;margin-top:10px}
    .mod .foot{color:var(--muted);font-size:12px;margin-top:6px}
    .spark{width:100%;height:54px;margin-top:10px}
    .badge{position:absolute;top:12px;right:12px;background:var(--soft);border:1px solid #222;padding:6px 10px;border-radius:999px;font-size:12px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#0f0f0f;border:1px solid #1e1e1e;padding:6px 10px;border-radius:999px;font-size:12px}
    .chip i{width:8px;height:8px;border-radius:999px;background:var(--primary)}

    /* KPI GRID secundário */
    .grid{display:grid;gap:18px;grid-template-columns:repeat(3,1fr);margin-top:22px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)), var(--panel);border:1px solid #1c1c1c;border-radius:var(--card-radius);padding:16px 18px;box-shadow:var(--shadow);position:relative;overflow:hidden}
    .card h3{margin:0 0 4px;font-size:14px;font-weight:600;color:var(--muted)}
    .kpi-line{display:flex;align-items:center;justify-content:space-between}
    .kpi-value{font-size:28px;font-weight:700}
    .pill{font-size:12px;color:#0a0a0a;background:var(--primary);padding:4px 8px;border-radius:999px;font-weight:700}

    /* CHARTS maiores */
    .charts{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin-top:18px}
    .chart-card{padding:18px}
    canvas{width:100%;height:100%}

    /* ==== MODAL (popup grande) ==== */
    .modal-backdrop{
      position:fixed; inset:0; display:none; place-items:center;
      background:rgba(0,0,0,.55); backdrop-filter:saturate(110%) blur(4px);
      z-index:999;
    }
    .modal-backdrop.show{ display:grid; animation:fadeIn .18s ease-out }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    .modal{
      width:min(1100px, 92vw); max-height:86vh; overflow:auto;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)), var(--panel);
      border:1px solid #1e1e1e; border-radius:22px; box-shadow: var(--shadow);
    }
    .modal header{
      position:sticky; top:0; z-index:1;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px 18px; background:rgba(17,17,17,.9); border-bottom:1px solid #1f1f1f;
    }
    .modal h2{ margin:0; font-size:18px; letter-spacing:.2px }
    .modal .close{
      appearance:none; border:1px solid #2a2a2a; background:#0f0f0f; color:var(--ink);
      padding:8px 10px; border-radius:10px; cursor:pointer;
    }
    .modal .close:focus{ outline:2px solid var(--primary); outline-offset:2px }
    .modal .content{ padding:18px }
    .modal .filters{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px }
    .modal .filters select, .modal .filters input{
      background:var(--soft); border:1px solid #232323; color:var(--ink); padding:10px 12px; border-radius:12px;
    }
    .modal .kpis{ display:grid; gap:14px; grid-template-columns:repeat(4,1fr); margin-top:12px }
    .modal .kpis .k{ background:#0f0f0f; border:1px solid #1f1f1f; border-radius:14px; padding:12px 14px }
    .modal .k .label{ color:var(--muted); font-size:12px }
    .modal .k .val{ font-size:22px; font-weight:800; margin-top:4px }

    .modal .charts{ display:grid; grid-template-columns:2fr 1fr; gap:16px; margin-top:12px }
    .modal .chart-card{ background:#0f0f0f; border:1px solid #1f1f1f; border-radius:14px; padding:14px 14px 10px }
    .modal footer{
      display:flex; justify-content:flex-end; gap:10px; padding:14px 18px; border-top:1px solid #1f1f1f;
      background:rgba(17,17,17,.9); position:sticky; bottom:0;
    }
    .modal .btn-primary{
      background:var(--primary); color:#0a0a0a; border:0; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
      text-decoration:none; display:inline-block;
    }

    @media (max-width:1280px){.modules{grid-template-columns:repeat(3,1fr)}.charts{grid-template-columns:1fr}}
    @media (max-width:1100px){
      .modal .kpis{ grid-template-columns:repeat(2,1fr) }
      .modal .charts{ grid-template-columns:1fr }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Dashboard Unificado</div>
        <div class="subtitle">Versão Desktop • Paleta do print preto (ciano/rosa)</div>
      </div>
      <div class="controls">
        <select id="empresa">
          <option value="TODAS">Todas as empresas</option>
          <option>MERCATTO DELICIA</option>
          <option>DELICIA GOURMET</option>
          <option>PADARIA DELICIA</option>
          <option>VILLA GOURMET</option>
          <option>M. KIDS</option>
        </select>
        <input type="month" id="periodo" class="btn" />
        <button class="btn" id="btn-refresh">Atualizar</button>
      </div>
    </header>

    <!-- ===== MÓDULOS ===== -->
    <section class="modules">
      <a class="mod" data-mod="METAS" id="link-metas" href="#">
        <span class="badge">Metas</span>
        <h4>Metas</h4>
        <div class="desc">Faturamento vs. objetivo</div>
        <div class="kpi" id="kpi-metas">—</div>
        <canvas id="spark-metas" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--primary)"></i> Progresso</span></div>
      </a>
      <a class="mod" data-mod="CANCELAMENTOS" id="link-cancel" href="#">
        <span class="badge">Cancelamentos</span>
        <h4>Cancelamentos</h4>
        <div class="desc">Itens/valor cancelado</div>
        <div class="kpi" id="kpi-cancel">—</div>
        <canvas id="spark-cancel" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--danger)"></i> Risco</span></div>
      </a>
      <a class="mod" data-mod="TRAVAS" id="link-travas" href="#">
        <span class="badge">Travas</span>
        <h4>Travas de Compras</h4>
        <div class="desc">Planos válidos e já comprado</div>
        <div class="kpi" id="kpi-travas">—</div>
        <canvas id="spark-travas" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--warn)"></i> Alerta</span></div>
      </a>
      <a class="mod" data-mod="FINANCEIRO" id="link-fin" href="#">
        <span class="badge">Financeiro</span>
        <h4>Resumo Financeiro</h4>
        <div class="desc">Entradas x Saídas</div>
        <div class="kpi" id="kpi-fin">—</div>
        <canvas id="spark-fin" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--ok)"></i> Saldo</span></div>
      </a>
      <a class="mod" data-mod="DELIVERY" id="link-delivery" href="#">
        <span class="badge">Delivery</span>
        <h4>Vendas em Delivery</h4>
        <div class="desc">Pedidos / ticket médio</div>
        <div class="kpi" id="kpi-delivery">—</div>
        <canvas id="spark-delivery" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--primary)"></i> Crescimento</span></div>
      </a>
      <a class="mod" data-mod="CONCILIACAO" id="link-bank" href="#">
        <span class="badge">Bancária</span>
        <h4>Conciliação Bancária</h4>
        <div class="desc">Conferência de movimentos</div>
        <div class="kpi" id="kpi-bank">—</div>
        <canvas id="spark-bank" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--accent)"></i> Pendências</span></div>
      </a>
      <a class="mod" data-mod="PESQUISA" id="link-nps" href="#">
        <span class="badge">NPS</span>
        <h4>Pesquisa de Satisfação</h4>
        <div class="desc">NPS / avaliações</div>
        <div class="kpi" id="kpi-nps">—</div>
        <canvas id="spark-nps" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--ok)"></i> Pontuação</span></div>
      </a>
      <a class="mod" data-mod="MIDIAS" id="link-midias" href="#">
        <span class="badge">Mídias</span>
        <h4>Mídias Sociais</h4>
        <div class="desc">Views / engajamento</div>
        <div class="kpi" id="kpi-views">—</div>
        <canvas id="spark-views" class="spark"></canvas>
        <div class="foot"><span class="chip"><i style="background:var(--accent)"></i> Engaj.</span></div>
      </a>
    </section>

    <!-- KPIs gerais (exemplo) -->
    <section class="grid">
      <div class="card">
        <h3>Período</h3>
        <div class="kpi-line"><div class="kpi-value" id="kpi-competencia">—</div><span class="pill">Ativo</span></div>
      </div>
      <div class="card">
        <h3>Máquinas Stone</h3>
        <div class="kpi-line"><div class="kpi-value" id="kpi-func-ativos">—</div><span class="pill" style="background:var(--accent)">Ativos</span></div>
      </div>
      <div class="card">
        <h3>Requisições</h3>
        <div class="kpi-line"><div class="kpi-value" id="kpi-credito">—</div><span class="pill" style="background:var(--ok)">Créditos</span></div>
      </div>
    </section>

    <!-- CHARTS maiores (visual) -->
    <section class="charts">
      <div class="card chart-card">
        <h3>Timeline geral</h3>
        <canvas id="line-timeline" height="300"></canvas>
      </div>
      <div class="card chart-card">
        <h3>Dias mais ativos</h3>
        <canvas id="bar-days" height="300"></canvas>
      </div>
    </section>

    <div class="subtitle" style="margin-top:16px">
      Última atualização: <span id="last-update">—</span>
    </div>

    <!-- BOTÃO PARA COMPARAÇÃO -->
    <div style="text-align:center; margin:24px 0;">
     <a href="index.comparacao.html" style="
  display:inline-block;
  background:#0ea5e9;
  color:#fff;
  padding:12px 20px;
  border-radius:8px;
  font-size:15px;
  font-weight:600;
  text-decoration:none;
  box-shadow:0 2px 8px rgba(0,0,0,0.3);
  transition:0.2s;
" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(1)'">
  📊 Comparar com Mês Anterior
      </a>
    </div>
  </div> <!-- FECHA .wrap -->

  <!-- ===== MODAL UNIVERSAL DOS MÓDULOS ===== -->
  <div id="modal-backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <header>
        <h2 id="modal-title">Módulo</h2>
        <button class="close" id="modal-close" aria-label="Fechar (Esc)">✕</button>
      </header>
      <div class="content">
        <div class="filters">
          <select id="modal-empresa">
            <option value="TODAS">Todas as empresas</option>
            <option>MERCATTO DELICIA</option>
            <option>DELICIA GOURMET</option>
            <option>PADARIA DELICIA</option>
            <option>VILLA GOURMET</option>
            <option>M. KIDS</option>
          </select>
          <input type="month" id="modal-periodo" />
        </div>

        <div class="kpis" id="modal-kpis">
          <div class="k"><div class="label">Principal</div><div class="val" id="kpi-a">—</div></div>
          <div class="k"><div class="label">Secundário</div><div class="val" id="kpi-b">—</div></div>
          <div class="k"><div class="label">Tendência</div><div class="val" id="kpi-c">—</div></div>
          <div class="k"><div class="label">Δ M/M</div><div class="val" id="kpi-d">—</div></div>
        </div>

        <div class="charts">
          <div class="chart-card">
            <h3 style="margin:0 0 6px;color:var(--muted);font-size:13px">Série temporal</h3>
            <canvas id="modal-line" height="240"></canvas>
          </div>
          <div class="chart-card">
            <h3 style="margin:0 0 6px;color:var(--muted);font-size:13px">Distribuição</h3>
            <canvas id="modal-bar" height="240"></canvas>
          </div>
        </div>
      </div>
      <footer>
        <a id="modal-link-full" class="btn-primary" href="#" target="_blank" rel="noopener">Abrir página completa</a>
      </footer>
    </div>
  </div>

<script>
/**************** CONFIG ****************/
const CONFIG = {
  LINKS: {
    METAS: 'metas/index.html',
    CANCELAMENTOS: 'cancelamentos/index.html',
    TRAVAS: 'travas/index.html',
    FINANCEIRO: 'resumo-financeiro/index.html',
    DELIVERY: 'delivery/index.html',
    CONCILIACAO: 'conciliacao/index.html',
    PESQUISA: 'pesquisa/index.html',
    MIDIAS: 'midias/index.html'
  },
  APIS: {
    METAS: 'https://script.google.com/macros/s/AKfycbziCPWWJxxfrnSeT3RHsNbw21z9MfnnB8JpV7ZQcZnvUQQ7dL3lVJdpUG7epACVjFaO/exec',
    CANCELAMENTOS: 'https://script.google.com/macros/s/AKfycbzM1mmixFkFE5tbC-0Evc6GVyZEJkh88HCikNK08FujRwCrgUA1e_E29nMHip81kRPoSg/exec',
    PESQUISA: 'https://script.google.com/macros/s/AKfycbyK3A5CDn_EgA3pbRVToh87_qKWvbIry886OkR1AdkJi7RyvSgcwY0BmRqhbKQnEKwgrA/exec',
    TRAVAS: '',
    FINANCEIRO: '',
    DELIVERY: '',
    CONCILIACAO: '',
    MIDIAS: ''
  }
};

const $ = s => document.querySelector(s);
const fmt = new Intl.NumberFormat('pt-BR', {maximumFractionDigits:0});

/**************** CHART HELPERS ****************/
function spark(el, data, color='#00d1ff'){
  const ctx = document.getElementById(el);
  const g = ctx.getContext('2d').createLinearGradient(0,0,0,60);
  g.addColorStop(0, 'rgba(0,209,255,.35)');
  g.addColorStop(1, 'rgba(255,46,136,.05)');
  return new Chart(ctx,{type:'line',data:{labels:data.map((_,i)=>i+1),datasets:[{data, borderWidth:2, pointRadius:0, tension:.35, fill:true, backgroundColor:g, borderColor:'#00d1ff'}]},options:{plugins:{legend:{display:false},tooltip:{enabled:true}},scales:{x:{display:false},y:{display:false}},elements:{line:{borderJoinStyle:'round'}}});
}
function makeLine(ctx){
  return new Chart(ctx,{type:'line',data:{labels:[],datasets:[
    {label:'Likes',data:[],tension:.35,borderWidth:2,pointRadius:0,borderColor:'#00d1ff'},
    {label:'Novos seguidores',data:[],tension:.35,borderWidth:2,pointRadius:0,borderColor:'#ff2e88'}
  ]},options:{scales:{x:{ticks:{color:'#8b93a7'}},y:{grid:{color:'rgba(255,255,255,.06)'}}},plugins:{legend:{labels:{color:'#9aa3b8'}}}});
}
function makeBar(ctx){
  return new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'Eventos',data:[],backgroundColor:'#00d1ff'}]},options:{scales:{y:{grid:{color:'rgba(255,255,255,.06)'}}},plugins:{legend:{labels:{color:'#9aa3b8'}}}}});
}

/**************** FETCH HELPERS ****************/
function buildUrl(base, empresa, periodo){
  if(!base) return '';
  const u = new URL(base);
  if(empresa) u.searchParams.set('empresa', empresa);
  if(periodo) u.searchParams.set('periodo', periodo); // AAAA-MM
  return u.toString();
}
async function fetchJSON(url){
  const r = await fetch(url, {method:'GET'});
  if(!r.ok) throw new Error('Falha ao carregar '+url);
  return r.json();
}

/**************** ADAPTERS (transformam APIs) ****************/
const adapters = {
  metas: async (empresa,periodo)=>{
    if(!CONFIG.APIS.METAS) return null;
    const data = await fetchJSON(buildUrl(CONFIG.APIS.METAS, empresa, periodo));
    const meta = data.meta ?? data.META ?? 0;
    const real = data.realizado ?? data.REAL ?? 0;
    const progresso = meta>0 ? Math.round((real/meta)*100) : 0;
    const serie = data.serie ?? data.timeline ?? (data.valores || []);
    return { kpi: progresso+"%", spark: serie.slice(-12), kpis:{a:progresso+"%", b:"Meta R$ "+(meta||0).toLocaleString('pt-BR'), c:"Real R$ "+(real||0).toLocaleString('pt-BR'), d:(data.deltaMM ?? '—')} };
  },
  cancel: async (empresa,periodo)=>{
    if(!CONFIG.APIS.CANCELAMENTOS) return null;
    const data = await fetchJSON(buildUrl(CONFIG.APIS.CANCELAMENTOS, empresa, periodo));
    let total = data.total_cancelado ?? 0;
    if(Array.isArray(data)) total = data.reduce((s,it)=> s + (Number(it.valor)||0), 0);
    const serie = data.serie ?? (data.timeline || []);
    return { kpi: 'R$ '+ total.toLocaleString('pt-BR'), spark: serie.slice(-12), kpis:{a:'R$ '+total.toLocaleString('pt-BR'), b:(data.itens||'—')+' itens', c:(data.rate||'—')+'%', d:(data.deltaMM ?? '—')} };
  },
  travas: async (empresa,periodo)=>{
    if(!CONFIG.APIS.TRAVAS) return null;
    const data = await fetchJSON(buildUrl(CONFIG.APIS.TRAVAS, empresa, periodo));
    const v = data.comprado ?? 0; const serie = data.serie || [];
    return { kpi: 'R$ '+ v.toLocaleString('pt-BR'), spark: serie.slice(-12), kpis:{a:'R$ '+v.toLocaleString('pt-BR'), b:'Planos válidos: '+(data.validos??'—'), c:'Já compr.: '+(data.jaComprado??'—'), d:(data.deltaMM ?? '—')} };
  },
  financeiro: async (empresa,periodo)=>{
    if(!CONFIG.APIS.FINANCEIRO) return null;
    const d = await fetchJSON(buildUrl(CONFIG.APIS.FINANCEIRO, empresa, periodo));
    const saldo = (d.entradas||0) - (d.saidas||0);
    const serie = d.serie || [];
    return { kpi: 'R$ '+ saldo.toLocaleString('pt-BR'), spark: serie.slice(-12), kpis:{a:'R$ '+(d.entradas||0).toLocaleString('pt-BR'), b:'R$ '+(d.saidas||0).toLocaleString('pt-BR'), c:'Saldo R$ '+saldo.toLocaleString('pt-BR'), d:(d.deltaMM ?? '—')} };
  },
  delivery: async (empresa,periodo)=>{
    if(!CONFIG.APIS.DELIVERY) return null;
    const d = await fetchJSON(buildUrl(CONFIG.APIS.DELIVERY, empresa, periodo));
    const receita = d.total ?? d.receita ?? 0;
    const serie = d.serie || [];
    return { kpi: 'R$ '+ receita.toLocaleString('pt-BR'), spark: serie.slice(-12), kpis:{a:'Pedidos: '+(d.pedidos??'—'), b:'Ticket: R$ '+(d.ticket??'—'), c:'Receita: R$ '+receita.toLocaleString('pt-BR'), d:(d.deltaMM ?? '—')} };
  },
  conciliacao: async (empresa,periodo)=>{
    if(!CONFIG.APIS.CONCILIACAO) return null;
    const d = await fetchJSON(buildUrl(CONFIG.APIS.CONCILIACAO, empresa, periodo));
    const pend = d.pendencias ?? 0; const serie = d.serie || [];
    return { kpi: pend+' pend.', spark: serie.slice(-12), kpis:{a:pend+' pendências', b:'Conferidos: '+(d.conferidos??'—'), c:'Bancos: '+(d.bancos??'—'), d:(d.deltaMM ?? '—')} };
  },
  nps: async (empresa,periodo)=>{
    if(!CONFIG.APIS.PESQUISA) return null;
    const d = await fetchJSON(buildUrl(CONFIG.APIS.PESQUISA, empresa, periodo));
    const nps = d.nps ?? d.NPS ?? 0; const serie = d.serie || [];
    return { kpi: 'NPS '+ nps, spark: serie.slice(-12), kpis:{a:'NPS '+nps, b:'Promotores: '+(d.promotores??'—'), c:'Detratores: '+(d.detratores??'—'), d:(d.deltaMM ?? '—')} };
  },
  midias: async (empresa,periodo)=>{
    if(!CONFIG.APIS.MIDIAS) return null;
    const d = await fetchJSON(buildUrl(CONFIG.APIS.MIDIAS, empresa, periodo));
    const views = d.views ?? 0; const serie = d.serie || [];
    return { kpi: fmt.format(views), spark: serie.slice(-12), kpis:{a:'Views: '+fmt.format(views), b:'Engaj.: '+(d.engaj??'—'), c:'Novos seg.: '+(d.seguidores??'—'), d:(d.deltaMM ?? '—')} };
  }
};

/**************** RENDER DO DASHBOARD ****************/
let chartLine, chartBar, sparks = {};
function setLinks(){
  $('#link-metas').dataset.href  = CONFIG.LINKS.METAS;
  $('#link-cancel').dataset.href = CONFIG.LINKS.CANCELAMENTOS;
  $('#link-travas').dataset.href = CONFIG.LINKS.TRAVAS;
  $('#link-fin').dataset.href    = CONFIG.LINKS.FINANCEIRO;
  $('#link-delivery').dataset.href = CONFIG.LINKS.DELIVERY;
  $('#link-bank').dataset.href   = CONFIG.LINKS.CONCILIACAO;
  $('#link-nps').dataset.href    = CONFIG.LINKS.PESQUISA;
  $('#link-midias').dataset.href = CONFIG.LINKS.MIDIAS;
}

function renderModule(idKpi, idSpark, payload){
  if(!payload) return;
  $(idKpi).textContent = payload.kpi || '—';
  if(payload.spark && payload.spark.length){ sparks[idSpark] = spark(idSpark, payload.spark); }
}

async function loadModules(){
  const emp = $('#empresa').value;
  const per = $('#periodo').value;
  const results = await Promise.allSettled([
    adapters.metas(emp,per), adapters.cancel(emp,per), adapters.travas(emp,per),
    adapters.financeiro(emp,per), adapters.delivery(emp,per),
    adapters.conciliacao(emp,per), adapters.nps(emp,per), adapters.midias(emp,per)
  ]);
  const [m,c,t,f,d,b,n,mi] = results.map(r=>r.status==='fulfilled'?r.value:null);
  if(m) renderModule('#kpi-metas','spark-metas', m);
  if(c) renderModule('#kpi-cancel','spark-cancel', c);
  if(t) renderModule('#kpi-travas','spark-travas', t);
  if(f) renderModule('#kpi-fin','spark-fin', f);
  if(d) renderModule('#kpi-delivery','spark-delivery', d);
  if(b) renderModule('#kpi-bank','spark-bank', b);
  if(n) renderModule('#kpi-nps','spark-nps', n);
  if(mi) renderModule('#kpi-views','spark-views', mi);
}

function bootstrapCharts(){
  chartLine = makeLine($('#line-timeline'));
  chartBar  = makeBar($('#bar-days'));
  // placeholders
  chartLine.data.labels = ['S1','S2','S3','S4','S5','S6','S7'];
  chartLine.data.datasets[0].data = [180,220,260,300,450,200,150];
  chartLine.data.datasets[1].data = [60,120,180,250,380,150,90];
  chartLine.update();
  chartBar.data.labels = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
  chartBar.data.datasets[0].data = [16,8,11,16,9,8,7];
  chartBar.update();
}

/**************** MODAL UNIVERSAL ****************/
let MODAL = { line:null, bar:null, currentKey:null };

function openModal(modKey, title, fullHref){
  const $b = $('#modal-backdrop');
  $('#modal-title').textContent = title;
  $('#modal-link-full').href = fullHref || '#';
  $('#modal-empresa').value = $('#empresa').value;
  $('#modal-periodo').value = $('#periodo').value;

  if(!MODAL.line){
    MODAL.line = new Chart($('#modal-line'), {
      type:'line',
      data:{ labels:[], datasets:[{label:'Série', data:[], tension:.35, borderWidth:2, pointRadius:0, borderColor:'#00d1ff' }]},
      options:{ plugins:{legend:{labels:{color:'#9aa3b8'}}}, scales:{x:{ticks:{color:'#8b93a7'}}, y:{grid:{color:'rgba(255,255,255,.06)'}}} }
    });
  }
  if(!MODAL.bar){
    MODAL.bar = new Chart($('#modal-bar'), {
      type:'bar',
      data:{ labels:[], datasets:[{label:'Qtd', data:[], backgroundColor:'#ff2e88'}]},
      options:{ plugins:{legend:{labels:{color:'#9aa3b8'}}}, scales:{y:{grid:{color:'rgba(255,255,255,.06)'}}} }
    });
  }
  MODAL.currentKey = modKey;
  $b.classList.add('show');
  $b.setAttribute('aria-hidden','false');
  loadModalData(); // carrega conteúdo
}

function closeModal(){
  const $b = $('#modal-backdrop');
  $b.classList.remove('show');
  $b.setAttribute('aria-hidden','true');
}

async function loadModalData(){
  const empresa = $('#modal-empresa').value;
  const periodo = $('#modal-periodo').value;
  const key = MODAL.currentKey;

  // escolhe adapter
  const map = {
    METAS: adapters.metas,
    CANCELAMENTOS: adapters.cancel,
    TRAVAS: adapters.travas,
    FINANCEIRO: adapters.financeiro,
    DELIVERY: adapters.delivery,
    CONCILIACAO: adapters.conciliacao,
    PESQUISA: adapters.nps,
    MIDIAS: adapters.midias
  };
  let payload = null;

  try{
    if(map[key]) payload = await map[key](empresa,periodo);
  }catch(e){
    // placeholder se API não existir ainda
    payload = null;
  }

  // KPIs + gráficos do modal
  const kpiA = $('#kpi-a'), kpiB=$('#kpi-b'), kpiC=$('#kpi-c'), kpiD=$('#kpi-d');
  if(payload){
    const series = payload.spark?.length ? payload.spark : Array.from({length:12},(_,i)=>Math.round(100+Math.random()*300));
    const labels = series.map((_,i)=>'P'+(i+1));
    MODAL.line.data.labels = labels;
    MODAL.line.data.datasets[0].data = series;
    MODAL.line.update();

    MODAL.bar.data.labels = ['A','B','C','D','E','F'];
    MODAL.bar.data.datasets[0].data = Array.from({length:6},()=>Math.round(10+Math.random()*40));
    MODAL.bar.update();

    kpiA.textContent = payload.kpis?.a ?? payload.kpi ?? '—';
    kpiB.textContent = payload.kpis?.b ?? '—';
    kpiC.textContent = payload.kpis?.c ?? '—';
    kpiD.textContent = payload.kpis?.d ?? '—';
  } else {
    // fallback visual
    const series = Array.from({length:12},(_,i)=>Math.round(100+Math.random()*300));
    const labels = series.map((_,i)=>'P'+(i+1));
    MODAL.line.data.labels = labels;
    MODAL.line.data.datasets[0].data = series;
    MODAL.line.update();

    MODAL.bar.data.labels = ['A','B','C','D','E','F'];
    MODAL.bar.data.datasets[0].data = Array.from({length:6},()=>Math.round(10+Math.random()*40));
    MODAL.bar.update();

    kpiA.textContent = '—';
    kpiB.textContent = '—';
    kpiC.textContent = '—';
    kpiD.textContent = '—';
  }
}

/**************** BOOTSTRAP ****************/
window.addEventListener('DOMContentLoaded', ()=>{
  setLinks();
  $('#periodo').value = new Date().toISOString().slice(0,7);
  $('#kpi-competencia').textContent = $('#periodo').value.split('-').reverse().join('/');
  $('#kpi-func-ativos').textContent = '—';
  $('#kpi-credito').textContent = '—';
  $('#last-update').textContent = new Date().toLocaleString('pt-BR');

  bootstrapCharts();
  loadModules();

  // click nos módulos -> abre modal
  document.querySelectorAll('.mod').forEach(el=>{
    el.addEventListener('click', (e)=>{
      e.preventDefault();
      const key = el.dataset.mod;
      const title = el.querySelector('h4')?.textContent?.trim() || 'Módulo';
      const href = el.dataset.href || '#';
      openModal(key, title, href);
    });
  });

  // filtros gerais recarregam módulos
  $('#btn-refresh').addEventListener('click', loadModules);
  $('#empresa').addEventListener('change', loadModules);
  $('#periodo').addEventListener('change', ()=>{
    $('#kpi-competencia').textContent = $('#periodo').value.split('-').reverse().join('/');
    loadModules();
  });

  // modal: eventos
  $('#modal-close').addEventListener('click', closeModal);
  $('#modal-backdrop').addEventListener('click', (e)=>{ if(e.target.id==='modal-backdrop') closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  // filtros do modal recarregam conteúdo
  $('#modal-empresa').addEventListener('change', loadModalData);
  $('#modal-periodo').addEventListener('change', loadModalData);
});
</script>
</body>
</html>
