<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Unificado • Dark</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#0a0a0a;--panel:#111111;--soft:#161616;--ink:#f5f7ff;--muted:#a9b0c2;--primary:#00d1ff;--accent:#ff2e88;--ok:#37d399;--warn:#fec84b;--danger:#f43f5e;--card-radius:18px;--shadow:0 10px 40px rgba(0,0,0,.45)}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:
      radial-gradient(1100px 720px at 65% -10%, rgba(0,209,255,.12), transparent 60%),
      radial-gradient(900px 540px at -10% 15%, rgba(255,46,136,.10), transparent 55%),
      var(--bg);color:var(--ink)}
    .wrap{max-width:1500px;margin:32px auto;padding:0 24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
    .title{font-size:28px;font-weight:700} .subtitle{color:var(--muted);font-size:14px}
    .controls{display:flex;gap:12px;align-items:center}
    .btn,select{background:var(--panel);border:1px solid #1f1f1f;color:var(--ink);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow)}
    .btn[disabled]{opacity:.7;cursor:not-allowed}
    .modules{display:grid;gap:18px;grid-template-columns:repeat(4,1fr)}
    .mod{position:relative;text-decoration:none;color:inherit;background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)),var(--panel);border:1px solid #1e1e1e;border-radius:var(--card-radius);padding:18px;box-shadow:var(--shadow)}
    .mod h4{margin:0 0 6px;font-size:16px;font-weight:700} .desc{color:var(--muted);font-size:12px}
    .kpi{font-size:26px;font-weight:800;margin-top:10px} .badge{position:absolute;top:12px;right:12px;background:#161616;border:1px solid #222;padding:6px 10px;border-radius:999px;font-size:12px}
    .grid{display:grid;gap:18px;grid-template-columns:repeat(3,1fr);margin-top:22px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)),var(--panel);border:1px solid #1c1c1c;border-radius:var(--card-radius);padding:16px 18px;box-shadow:var(--shadow);position:relative}
    .kpi-line{display:flex;align-items:center;justify-content:space-between}
    .kpi-value{font-size:28px;font-weight:700;min-height:34px}
    .pill{font-size:12px;color:#0a0a0a;background:var(--primary);padding:4px 8px;border-radius:999px;font-weight:700}
    .charts{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin-top:18px}
    .chart-card{padding:18px}
    .spinner{width:16px;height:16px;border:2px solid #2a2a2a;border-top-color:var(--primary);border-radius:50%;display:inline-block;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .overlay{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);backdrop-filter:blur(1px)} .overlay.show{display:grid}
    .toast{position:fixed;right:18px;bottom:18px;background:#111;border:1px solid #2a2a2a;color:var(--ink);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);display:none;max-width:min(90vw,460px);z-index:9999}
    .toast.show{display:block}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);backdrop-filter:saturate(110%) blur(4px);z-index:999}
    .modal-backdrop.show{display:grid}
    .modal{width:min(1100px,92vw);max-height:86vh;overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)),var(--panel);border:1px solid #1e1e1e;border-radius:22px;box-shadow:var(--shadow)}
    .modal header{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;padding:16px 18px;background:rgba(17,17,17,.9);border-bottom:1px solid #1f1f1f}
    .modal .content{padding:18px;position:relative}
    .modal .filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .modal .kpis{display:grid;gap:14px;grid-template-columns:repeat(4,1fr)}
    table{width:100%;border-collapse:collapse;margin-top:12px} th,td{padding:8px 10px;border-bottom:1px solid #1f1f1f;font-size:13px}
    td.num{text-align:right} .in{color:var(--ok)} .out{color:var(--danger)}
    @media (max-width:1280px){.modules{grid-template-columns:repeat(3,1fr)}.charts{grid-template-columns:1fr}}
    @media (max-width:1100px){.modal .kpis{grid-template-columns:repeat(2,1fr)}.modal .charts{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Dashboard Unificado</div>
        <div class="subtitle">Versão Desktop • Paleta do print preto (ciano/rosa)</div>
      </div>
      <div class="controls">
        <select id="empresa">
          <option value="TODAS">Todas as empresas</option>
          <option>MERCATTO DELICIA</option>
          <option>DELICIA GOURMET</option>
          <option>PADARIA DELICIA</option>
          <option>VILLA GOURMET</option>
          <option>M. KIDS</option>
        </select>
        <input type="month" id="periodo" class="btn" />
        <button class="btn" id="btn-refresh">Atualizar</button>
      </div>
    </header>

    <section class="modules">
      <a class="mod" data-mod="FINANCEIRO" id="link-fin" href="#"><span class="badge">Financeiro</span><h4>Resumo Financeiro</h4><div class="desc">Entradas x Saídas</div><div class="kpi" id="kpi-fin">—</div></a>
      <!-- demais cards mantidos… -->
    </section>

    <section class="grid">
      <div class="card" id="card-periodo">
        <div class="overlay" id="card-loader"><div><span class="spinner"></span> Carregando…</div></div>
        <h3>Saldo na Loja (mês)</h3>
        <div class="kpi-line">
          <div class="kpi-value" id="kpi-competencia">—</div>
          <span class="pill" id="btn-detalhar">Detalhar</span>
        </div>
        <div class="subtitle" id="lbl-periodo" style="margin-top:6px;color:#a9b0c2">—</div>
        <div class="subtitle" id="debug-msg" style="margin-top:6px;color:#fca5a5"></div>
      </div>

      <div class="card"><h3>Máquinas Stone</h3><div class="kpi-line"><div class="kpi-value">—</div><span class="pill" style="background:#ff2e88">Ativos</span></div></div>
      <div class="card"><h3>Requisições</h3><div class="kpi-line"><div class="kpi-value">—</div><span class="pill" style="background:#37d399">Créditos</span></div></div>
    </section>

    <section class="charts">
      <div class="card chart-card"><h3>Timeline geral</h3><canvas id="line-timeline" height="300"></canvas></div>
      <div class="card chart-card"><h3>Dias mais ativos</h3><canvas id="bar-days" height="300"></canvas></div>
    </section>

    <div class="subtitle" style="margin-top:16px">Última atualização: <span id="last-update">—</span></div>
  </div>

  <!-- Modal -->
  <div id="modal-backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h2>Livro de Caixa (Entradas x Saídas)</h2>
        <button class="btn" id="modal-close">Fechar</button>
      </header>
      <div class="content">
        <div class="overlay" id="modal-loader"><div><span class="spinner"></span> Carregando…</div></div>

        <div class="filters">
          <select id="modal-empresa">
            <option value="TODAS">Todas as empresas</option>
            <option>MERCATTO DELICIA</option>
            <option>DELICIA GOURMET</option>
            <option>PADARIA DELICIA</option>
            <option>VILLA GOURMET</option>
            <option>M. KIDS</option>
          </select>
          <input type="month" id="modal-periodo" />
        </div>

        <div class="kpis">
          <div><div style="color:#a9b0c2;font-size:12px">Entradas (mês)</div><div class="kpi-value" id="kpi-a">—</div></div>
          <div><div style="color:#a9b0c2;font-size:12px">Saídas (mês)</div><div class="kpi-value" id="kpi-b">—</div></div>
          <div><div style="color:#a9b0c2;font-size:12px">Saldo do mês</div><div class="kpi-value" id="kpi-c">—</div></div>
          <div><div style="color:#a9b0c2;font-size:12px">Saldo na Loja</div><div class="kpi-value" id="kpi-d">—</div></div>
        </div>

        <table id="livro-tabela"><thead><tr><th>Data</th><th>Histórico</th><th>Complemento</th><th class="num">Entrada</th><th class="num">Saída</th></tr></thead><tbody></tbody></table>

        <div class="charts">
          <div class="chart-card"><canvas id="modal-line" height="240"></canvas></div>
          <div class="chart-card"><canvas id="modal-bar" height="240"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ======= CONFIG ======= */
const CONFIG = {
  DEMO: false, // mude para true se quiser ver dados fictícios
  APIS: { FINANCEIRO: 'https://script.google.com/macros/s/AKfycbzvL6FhF4BFPg2PMSIzWkB6QZhiqWl15yc9u48BwzR2BnI7y3kwMQXCQN7b9Pps1239KQ/exec' }
};
const $ = s => document.querySelector(s);
const fmt = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});

/* ======= UI Helpers ======= */
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),4000); }
function busy(el, on){ el.classList.toggle('show', !!on); }
function setBtnLoading(on){ const b=$('#btn-refresh'); if(on){b.disabled=true;b.textContent='Carregando…'} else {b.disabled=false;b.textContent='Atualizar'} }

/* ======= FETCH ======= */
function buildUrl(base, emp, per){ const u=new URL(base); if(emp&&emp!=='TODAS') u.searchParams.set('empresa', emp); if(per) u.searchParams.set('periodo', per); return u.toString(); }

async function fetchJSON(url){
  const r = await fetch(url, { headers:{'cache-control':'no-cache'} });
  const body = await r.text();
  const ct = (r.headers.get('content-type')||'').toLowerCase();
  if(!ct.includes('application/json')) throw new Error(`Resposta não-JSON (status ${r.status})`);
  return JSON.parse(body);
}

/* ======= DEMO DATA ======= */
function demoFinanceiro(periodo){
  const dias = Array.from({length:28}, (_,i)=>i+1);
  let saldo=0;
  const serie = dias.map(d=>{ const ent=Math.random()*2000; const sai=Math.random()*1500; saldo += ent-sai; return {dia:String(d).padStart(2,'0'), saldo:Math.round(saldo), movimentos:Math.floor(Math.random()*4)}; });
  const entradas = 50000, saidas= 41200;
  return { saldoLoja: entradas-saidas, entradas, saidas, saldoMes: entradas-saidas, serie, lancamentos: [
    {data:'01/'+periodo.split('-').reverse().join('/'), historico:'Caixa dia 01', complemento:'', entrada:1200, saida:0},
    {data:'02/'+periodo.split('-').reverse().join('/'), historico:'Compra', complemento:'Fornecedor X', entrada:0, saida:800}
  ]};
}

/* ======= ADAPTER ======= */
async function getFinanceiro(empresa, periodo){
  if (CONFIG.DEMO) return demoFinanceiro(periodo);
  const url = buildUrl(CONFIG.APIS.FINANCEIRO, empresa, periodo);
  const data = await fetchJSON(url);
  if (data && data.ok === false) throw new Error(data.error||'Erro no Apps Script');
  return {
    saldoLoja: Number(data.saldoLoja||0),
    entradas: Number(data.totais?.entradas||0),
    saidas: Number((data.totais?.saídas ?? data.totais?.sa) || 0),
    saldoMes: Number((data.totais?.entradas||0) - ((data.totais?.saídas ?? data.totais?.sa) || 0)),
    serie: Array.isArray(data.serie)?data.serie:[],
    lancamentos: Array.isArray(data.lancamentos)?data.lancamentos:[]
  };
}

/* ======= RENDER ======= */
let line, bar, modalLine, modalBar;

function initCharts(){
  const L = document.getElementById('line-timeline'); const B = document.getElementById('bar-days');
  line = new Chart(L, {type:'line', data:{labels:[], datasets:[{label:'Série',data:[],borderWidth:2,pointRadius:0,tension:.35,borderColor:'#00d1ff'}]}});
  bar  = new Chart(B, {type:'bar',  data:{labels:[], datasets:[{label:'Eventos',data:[],backgroundColor:'#ff2e88'}]}});

  modalLine = new Chart(document.getElementById('modal-line'), {type:'line', data:{labels:[], datasets:[{label:'Saldo diário',data:[],borderWidth:2,pointRadius:0,tension:.35,borderColor:'#00d1ff'}]}});
  modalBar  = new Chart(document.getElementById('modal-bar'),  {type:'bar',  data:{labels:[], datasets:[{label:'Movimentos',data:[],backgroundColor:'#ff2e88'}]}});
}

async function loadCard(){
  const emp = $('#empresa').value;
  const per = $('#periodo').value;

  $('#debug-msg').textContent='';
  busy($('#card-loader'), true); setBtnLoading(true);

  try{
    const fin = await getFinanceiro(emp, per);
    $('#kpi-competencia').textContent = fmt.format(fin.saldoLoja||0);
    $('#lbl-periodo').textContent = `Período: ${per.split('-').reverse().join('/')}`;

    // Atualiza charts principais com algo (exemplo: saldo)
    const labels = fin.serie.map(p=>p.dia);
    line.data.labels = labels; line.data.datasets[0].data = fin.serie.map(p=>p.saldo); line.update();
    bar.data.labels = labels;  bar.data.datasets[0].data = fin.serie.map(p=>p.movimentos); bar.update();

    window.__FIN_CACHE__ = { emp, per, fin };
  }catch(err){
    $('#kpi-competencia').textContent = '—';
    $('#lbl-periodo').textContent = 'Falha ao carregar';
    const url = buildUrl(CONFIG.APIS.FINANCEIRO, emp, per);
    $('#debug-msg').innerHTML = `Erro: ${err.message}. <a href="${url}" target="_blank" rel="noopener">Testar API</a>`;
    toast('Erro ao carregar dados financeiros.');
  }finally{
    busy($('#card-loader'), false); setBtnLoading(false);
    $('#last-update').textContent = new Date().toLocaleString('pt-BR');
  }
}

async function openModal(){
  const m = $('#modal-backdrop');
  $('#modal-empresa').value = $('#empresa').value;
  $('#modal-periodo').value = $('#periodo').value;
  m.classList.add('show');
  await refreshModal();
}
function closeModal(){ $('#modal-backdrop').classList.remove('show'); }

async function refreshModal(){
  const empresa = $('#modal-empresa').value;
  const periodo = $('#modal-periodo').value;
  busy($('#modal-loader'), true);
  try{
    const fin = await getFinanceiro(empresa, periodo);
    $('#kpi-a').textContent = fmt.format(fin.entradas||0);
    $('#kpi-b').textContent = fmt.format(fin.saidas||0);
    $('#kpi-c').textContent = fmt.format(fin.saldoMes||0);
    $('#kpi-d').textContent = fmt.format(fin.saldoLoja||0);

    const tb = $('#livro-tabela tbody'); tb.innerHTML='';
    fin.lancamentos.forEach(l=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l.data||''}</td><td>${l.historico||''}</td><td>${l.complemento||''}</td>
                      <td class="num in">${l.entrada?fmt.format(l.entrada):''}</td>
                      <td class="num out">${l.saida?fmt.format(l.saida):''}</td>`;
      tb.appendChild(tr);
    });

    modalLine.data.labels = fin.serie.map(p=>p.dia);
    modalLine.data.datasets[0].data = fin.serie.map(p=>p.saldo); modalLine.update();
    modalBar.data.labels = fin.serie.map(p=>p.dia);
    modalBar.data.datasets[0].data = fin.serie.map(p=>p.movimentos); modalBar.update();
  }catch(err){
    toast('Erro ao carregar o detalhamento.');
    ['kpi-a','kpi-b','kpi-c','kpi-d'].forEach(id=>$('#'+id).textContent='—');
    $('#livro-tabela tbody').innerHTML='';
  }finally{
    busy($('#modal-loader'), false);
  }
}

/* ======= BOOT ======= */
document.addEventListener('DOMContentLoaded', ()=>{
  // mês atual padrão
  $('#periodo').value = new Date().toISOString().slice(0,7);
  $('#lbl-periodo').textContent = `Período: ${$('#periodo').value.split('-').reverse().join('/')}`;
  initCharts();
  loadCard();

  $('#btn-refresh').addEventListener('click', loadCard);
  $('#empresa').addEventListener('change', loadCard);
  $('#periodo').addEventListener('change', ()=>{ $('#lbl-periodo').textContent = `Período: ${$('#periodo').value.split('-').reverse().join('/')}`; loadCard(); });

  $('#btn-detalhar').addEventListener('click', openModal);
  $('#modal-close').addEventListener('click', closeModal);
  $('#modal-backdrop').addEventListener('click', (e)=>{ if(e.target.id==='modal-backdrop') closeModal(); });
  $('#modal-empresa').addEventListener('change', refreshModal);
  $('#modal-periodo').addEventListener('change', refreshModal);
});
</script>
</body>
</html>
