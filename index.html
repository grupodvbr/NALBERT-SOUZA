<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Livro de Caixa — Pop‑up</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0a0a;--panel:#0f0f0f;--soft:#141414;--ink:#f5f7ff;--muted:#9aa3b8;--ok:#16a34a;--bad:#dc2626;--warn:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 Inter,system-ui,Segoe UI,Arial}
    .wrap{max-width:1280px;margin:18px auto;padding:0 16px}

    .panel{background:var(--panel);border:1px solid #1a1a1a;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .filters{display:flex;gap:10px;flex-wrap:wrap}
    .filters label{display:grid;gap:6px}
    .hint{color:var(--muted);font-size:12px}
    select,input{background:#0b0b0b;border:1px solid #1f1f1f;color:var(--ink);border-radius:10px;padding:10px 12px}

    .kpis{display:grid;gap:12px;grid-template-columns:repeat(4,1fr);margin-top:12px}
    .k{background:var(--soft);border:1px solid #1f1f1f;border-radius:14px;padding:14px}
    .k .label{color:var(--muted);font-size:12px}
    .k .val{font-size:22px;font-weight:800;margin-top:6px}
    .k.ok .val{color:var(--ok)}
    .k.bad .val{color:var(--bad)}

    .table-card{background:var(--soft);border:1px solid #1f1f1f;border-radius:14px;margin-top:12px}
    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:#121212}
    th,td{padding:12px;border-bottom:1px solid #1f1f1f;text-align:left}
    tbody tr:hover{background:#101010}
    .right{text-align:right}
    .empty{opacity:.6;text-align:center;padding:24px}

    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #222;background:#0b0b0b;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="topbar">
        <div class="pill">Pop‑up • Livro de Caixa</div>
        <div class="pill">Atualizado: <span id="updated">—</span></div>
      </div>

      <!-- Filtros -->
      <div class="filters">
        <label>
          <span class="hint">Empresa</span>
          <select id="empresa"></select>
        </label>
        <label>
          <span class="hint">Data inicial</span>
          <input type="date" id="dtIni">
        </label>
        <label>
          <span class="hint">Data final</span>
          <input type="date" id="dtFim">
        </label>
        <label style="flex:1 1 280px">
          <span class="hint">Buscar</span>
          <input type="text" id="busca" placeholder="histórico ou complemento">
        </label>
      </div>

      <!-- KPIs -->
      <div class="kpis">
        <div class="k" id="k-saldo-impl"><div class="label">Saldo na implantação</div><div class="val">—</div></div>
        <div class="k" id="k-entradas"><div class="label">Total de Entradas</div><div class="val">—</div></div>
        <div class="k" id="k-saidas"><div class="label">Total de Saídas</div><div class="val">—</div></div>
        <div class="k" id="k-saldo"><div class="label">Saldo no Período</div><div class="val">—</div></div>
      </div>

      <!-- Tabela -->
      <div class="table-card">
        <div style="overflow:auto;max-height:62vh">
          <table id="tbl">
            <thead>
              <tr>
                <th style="width:120px">Data</th>
                <th>Histórico</th>
                <th>Complemento</th>
                <th class="right" style="width:120px">Entrada</th>
                <th class="right" style="width:120px">Saída</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="empty" id="empty" hidden>Nenhum lançamento no período.</div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzqg8GEPFmod6W1xPxneXHAC6LRmnNAastew3QJtMpsf8mWwRowcZKZoNgRQskBM0-p/exec?action=list";

    const fmt = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    let raw = null; // payload do servidor
    let current = null; // empresa corrente

    // ========= LOAD =========
    async function load(){
      const res = await fetch(WEB_APP_URL,{cache:'no-store'});
      const data = await res.json();
      if (data.error) throw new Error(data.message||'Falha ao carregar');
      raw = data;
      document.getElementById('updated').textContent = new Date(data.generatedAt).toLocaleString('pt-BR');
      buildEmpresaOptions();
      applyQueryString();
      // defaults se não vierem por QS
      const sel = document.getElementById('empresa');
      if (!sel.value){ sel.value = raw.companies?.[0]?.company || ''; }
      const now = new Date();
      if (!document.getElementById('dtIni').value) document.getElementById('dtIni').valueAsDate = new Date(now.getFullYear(), now.getMonth(), 1);
      if (!document.getElementById('dtFim').value) document.getElementById('dtFim').valueAsDate = new Date(now.getFullYear(), now.getMonth()+1, 0);
      render();
    }

    function buildEmpresaOptions(){
      const sel = document.getElementById('empresa');
      sel.innerHTML = (raw.companies||[]).map(c=>`<option value="${escapeHtml(c.company)}">${escapeHtml(c.company)}</option>`).join('');
      sel.onchange = render;
      document.getElementById('dtIni').onchange = render;
      document.getElementById('dtFim').onchange = render;
      document.getElementById('busca').oninput = render;
    }

    function applyQueryString(){
      const p = new URLSearchParams(location.search);
      const company = p.get('company');
      const dtIni = p.get('dtIni');
      const dtFim = p.get('dtFim');
      const q = p.get('q');
      if (company) document.getElementById('empresa').value = company;
      if (dtIni) document.getElementById('dtIni').value = dtIni;
      if (dtFim) document.getElementById('dtFim').value = dtFim;
      if (q) document.getElementById('busca').value = decodeURIComponent(q);
    }

    // ========= RENDER =========
    function render(){
      const f = getFilters();
      const rows = applyFilters(f);

      const entradas = rows.reduce((s,r)=>s+(r.entrada||0),0);
      const saidas   = rows.reduce((s,r)=>s+(r.saida||0),0);
      const saldoPeriodo = (current?.saldoImplantacao||0) + entradas - saidas;

      setK('k-saldo-impl', current?.saldoImplantacao||0, 'warn');
      setK('k-entradas', entradas, 'ok');
      setK('k-saidas',   saidas,   'bad');
      setK('k-saldo',    saldoPeriodo, saldoPeriodo>=0?'ok':'bad');

      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.data?new Date(r.data).toLocaleDateString('pt-BR'):''}</td>
          <td>${escapeHtml(r.historico||'')}</td>
          <td>${escapeHtml(r.complemento||'')}</td>
          <td class="right">${r.entrada?fmt.format(r.entrada):''}</td>
          <td class="right">${r.saida?fmt.format(r.saida):''}</td>
        </tr>
      `).join('');
      document.getElementById('empty').hidden = rows.length>0;
    }

    function getFilters(){
      return {
        company: document.getElementById('empresa').value,
        dtIni: document.getElementById('dtIni').value,
        dtFim: document.getElementById('dtFim').value,
        q: document.getElementById('busca').value.trim().toLowerCase()
      };
    }

    function applyFilters(f){
      current = raw.companies.find(c=>c.company===f.company) || raw.companies[0];
      if (!current) return [];
      const dtIni = f.dtIni ? new Date(f.dtIni) : null;
      const dtFim = f.dtFim ? new Date(f.dtFim) : null;
      return (current.items||[]).filter(it=>{
        let ok = true;
        if (dtIni) ok = ok && it.data && new Date(it.data) >= dtIni;
        if (dtFim) ok = ok && it.data && new Date(it.data) <= new Date(dtFim.getFullYear(), dtFim.getMonth(), dtFim.getDate(), 23,59,59);
        if (f.q){ const text = (it.historico+' '+it.complemento).toLowerCase(); ok = ok && text.includes(f.q); }
        return ok;
      });
    }

    function setK(id,val,cls){
      const el=document.getElementById(id);
      el.classList.remove('ok','bad','warn');
      if(cls) el.classList.add(cls);
      el.querySelector('.val').textContent = fmt.format(val||0);
    }

    function escapeHtml(s){
      return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // ========= Sincronização com a janela principal =========
    window.addEventListener('message', (evt)=>{
      const { type, payload } = evt.data||{};
      if (type === 'livrocaixa-filters'){
        if (payload.company) document.getElementById('empresa').value = payload.company;
        if (payload.dtIni) document.getElementById('dtIni').value = payload.dtIni;
        if (payload.dtFim) document.getElementById('dtFim').value = payload.dtFim;
        document.getElementById('busca').value = payload.q||'';
        render();
      }
    });

    load().catch(err=>{ alert('Erro ao carregar: '+err.message); console.error(err); });
  </script>
</body>
</html>
