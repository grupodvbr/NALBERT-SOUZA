<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel – Livro de Caixa</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0a0a;--panel:#111;--muted:#1a1a1a;--ink:#f6f7fb;--ok:#16a34a;--bad:#dc2626;--warn:#f59e0b;--accent:#22d3ee;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 Inter,system-ui,Segoe UI,Arial}
    header{padding:18px 20px;border-bottom:1px solid #222;display:flex;gap:16px;align-items:center}
    header h1{font-size:18px;margin:0;font-weight:700}
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    .panel{background:var(--panel);border:1px solid #1d1d1d;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:grid;gap:12px}
    .row.cols-4{grid-template-columns:repeat(4,1fr)}
    .row.cols-3{grid-template-columns:repeat(3,1fr)}
    .card{background:var(--muted);border:1px solid #222;border-radius:14px;padding:14px}
    .kpi .label{opacity:.8;font-size:12px}
    .kpi .value{font-size:22px;font-weight:700;margin-top:4px}
    .kpi.ok .value{color:var(--ok)}
    .kpi.bad .value{color:var(--bad)}
    .kpi.warn .value{color:var(--warn)}
    .filters{display:flex;gap:10px;flex-wrap:wrap}
    select,input{background:#0e0e0e;border:1px solid #222;color:var(--ink);border-radius:10px;padding:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #222}
    th{font-weight:600;text-align:left;background:#151515;position:sticky;top:0}
    tbody tr:hover{background:#111}
    .right{text-align:right}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid #222;background:#0e0e0e}
    footer{opacity:.7;padding:14px}
    .hint{opacity:.7}
    .empty{opacity:.6;text-align:center;padding:24px}
  </style>
</head>
<body>
  <header>
    <h1>Livro de Caixa – Painel</h1>
    <span class="pill" id="updated">…</span>
  </header>

  <div class="wrap">
    <div class="panel" style="padding:16px">
      <div class="filters">
        <label>
          <span class="hint">Empresa</span><br>
          <select id="empresa"></select>
        </label>
        <label>
          <span class="hint">Data inicial</span><br>
          <input type="date" id="dtIni">
        </label>
        <label>
          <span class="hint">Data final</span><br>
          <input type="date" id="dtFim">
        </label>
        <label style="flex:1 1 240px">
          <span class="hint">Buscar</span><br>
          <input type="text" id="busca" placeholder="histórico ou complemento">
        </label>
        <button id="btnExport" class="pill">Exportar CSV</button>
      </div>

      <div class="row cols-4" style="margin-top:12px">
        <div class="card kpi" id="kpi-saldo-impl">
          <div class="label">Saldo na implantação</div>
          <div class="value">—</div>
        </div>
        <div class="card kpi" id="kpi-entradas">
          <div class="label">Total de Entradas</div>
          <div class="value">—</div>
        </div>
        <div class="card kpi" id="kpi-saidas">
          <div class="label">Total de Saídas</div>
          <div class="value">—</div>
        </div>
        <div class="card kpi" id="kpi-saldo">
          <div class="label">Saldo na Loja</div>
          <div class="value">—</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="overflow:auto;max-height:60vh">
          <table id="tbl">
            <thead>
              <tr>
                <th style="width:120px">Data</th>
                <th>Histórico</th>
                <th>Complemento</th>
                <th class="right" style="width:120px">Entrada</th>
                <th class="right" style="width:120px">Saída</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="empty" id="empty" hidden>Nenhum lançamento no período.</div>
        </div>
      </div>

    </div>

    <footer>💡 Dica: digite parte do histórico (ex.: "caixa dia").
    </footer>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzjlnQFhaCjGXmjIirF4qtUFReN4RSwYi4vE1oo8ORgydKz7d4WOiI2mA75ukC9B1DzPA/exec"; // ← Substitua

    let raw = null;
    let current = null; // empresa selecionada

    const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

    async function load() {
      const res = await fetch(WEB_APP_URL, { cache: 'no-store' });
      const data = await res.json();
      if (data.error) throw new Error(data.message || 'Falha ao carregar');
      raw = data;
      document.getElementById('updated').textContent = 'Atualizado: ' + new Date(data.generatedAt).toLocaleString('pt-BR');
      buildEmpresaOptions(data.companies.map(c => c.company));
      // Seleciona a primeira por padrão
      document.getElementById('empresa').value = data.companies[0]?.company || '';
      onChangeEmpresa();
    }

    function buildEmpresaOptions(list) {
      const sel = document.getElementById('empresa');
      sel.innerHTML = list.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
      sel.onchange = onChangeEmpresa;
      document.getElementById('dtIni').onchange = render;
      document.getElementById('dtFim').onchange = render;
      document.getElementById('busca').oninput = render;
      document.getElementById('btnExport').onclick = exportCsv;
    }

    function onChangeEmpresa() {
      const name = document.getElementById('empresa').value;
      current = raw.companies.find(c => c.company === name);
      // define período padrão: mês atual
      const now = new Date();
      const first = new Date(now.getFullYear(), now.getMonth(), 1);
      const last  = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      document.getElementById('dtIni').valueAsDate = first;
      document.getElementById('dtFim').valueAsDate = last;
      render();
    }

    function render() {
      if (!current) return;
      const dtIni = document.getElementById('dtIni').value ? new Date(document.getElementById('dtIni').value) : null;
      const dtFim = document.getElementById('dtFim').value ? new Date(document.getElementById('dtFim').value) : null;
      const q = document.getElementById('busca').value.trim().toLowerCase();

      const rows = (current.items || []).filter(it => {
        // filtro de data
        let okDate = true;
        if (dtIni) okDate = okDate && it.data && new Date(it.data) >= dtIni;
        if (dtFim) okDate = okDate && it.data && new Date(it.data) <= new Date(dtFim.getFullYear(), dtFim.getMonth(), dtFim.getDate(), 23,59,59);
        // filtro de busca
        const text = (it.historico + ' ' + it.complemento).toLowerCase();
        const okText = !q || text.includes(q);
        return okDate && okText;
      });

      // KPIs do período
      const entradas = rows.reduce((s, r) => s + (r.entrada||0), 0);
      const saidas   = rows.reduce((s, r) => s + (r.saida||0), 0);
      const saldoLoja = (current.saldoImplantacao||0) + entradas - saidas; // preferimos o cálculo do período

      setKpi('kpi-saldo-impl', current.saldoImplantacao, 'warn');
      setKpi('kpi-entradas', entradas, 'ok');
      setKpi('kpi-saidas', saidas, 'bad');
      setKpi('kpi-saldo', saldoLoja, saldoLoja >= 0 ? 'ok' : 'bad');

      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.data ? new Date(r.data).toLocaleDateString('pt-BR') : ''}</td>
          <td>${escapeHtml(r.historico||'')}</td>
          <td>${escapeHtml(r.complemento||'')}</td>
          <td class="right">${r.entrada ? fmt.format(r.entrada) : ''}</td>
          <td class="right">${r.saida ? fmt.format(r.saida) : ''}</td>
        </tr>
      `).join('');

      document.getElementById('empty').hidden = rows.length > 0;
    }

    function setKpi(id, value, cls) {
      const el = document.getElementById(id);
      el.classList.remove('ok','bad','warn');
      if (cls) el.classList.add(cls);
      el.querySelector('.value').textContent = fmt.format(value || 0);
    }

    function exportCsv() {
      if (!current) return;
      const dtIni = document.getElementById('dtIni').value;
      const dtFim = document.getElementById('dtFim').value;
      const q = document.getElementById('busca').value.trim().toLowerCase();

      const rows = (current.items || []).filter(it => {
        let ok = true;
        if (dtIni) ok = ok && it.data && new Date(it.data) >= new Date(dtIni);
        if (dtFim) ok = ok && it.data && new Date(it.data) <= new Date(dtFim + 'T23:59:59');
        const text = (it.historico + ' ' + it.complemento).toLowerCase();
        if (q) ok = ok && text.includes(q);
        return ok;
      });

      const header = ['Data','Histórico','Complemento','Entrada','Saída'];
      const csv = [header.join(';')].concat(rows.map(r => [
        r.data ? new Date(r.data).toLocaleDateString('pt-BR') : '',
        safeCsv(r.historico),
        safeCsv(r.complemento),
        r.entrada?.toString().replace('.',','),
        r.saida?.toString().replace('.',',')
      ].join(';'))).join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `livro_caixa_${current.company.replace(/\s+/g,'_')}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function safeCsv(s){
      const t = (s||'').toString().replace(/;/g, ',');
      return '"'+t.replace(/"/g,'""')+'"';
    }

    function escapeHtml(s){
      return (s||'').toString()
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/\"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    load().catch(err => {
      alert('Erro ao carregar: '+ err.message);
      console.error(err);
    });
  </script>
</body>
</html>
