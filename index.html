<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Unificado</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#0a0a0a; --panel:#111111; --soft:#161616; --ink:#f5f7ff; --muted:#a9b0c2;
    --primary:#00d1ff; --accent:#ff2e88; --ok:#37d399; --warn:#fec84b; --danger:#f43f5e;
    --card-radius:18px; --shadow:0 10px 40px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:
      radial-gradient(1100px 720px at 65% -10%, rgba(0,209,255,.12), transparent 60%),
      radial-gradient(900px 540px at -10% 15%, rgba(255,46,136,.10), transparent 55%),
      var(--bg); color:var(--ink);
  }
  .wrap{max-width:1500px;margin:32px auto;padding:0 24px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
  .title{font-size:28px;font-weight:700;letter-spacing:.3px}
  .subtitle{color:var(--muted);font-size:14px}
  .controls{display:flex;gap:12px;align-items:center}
  .btn, select, input[type="month"]{
    background:var(--panel); border:1px solid #1f1f1f; color:var(--ink);
    padding:10px 14px; border-radius:12px; box-shadow:var(--shadow)
  }
  .btn{cursor:pointer}.btn:hover{filter:brightness(1.08)}
  select{appearance:none}

  .modules{display:grid;gap:18px;grid-template-columns:repeat(4,1fr)}
  .mod{
    position:relative;display:block;color:inherit;text-decoration:none;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)),var(--panel);
    border:1px solid #1e1e1e;border-radius:var(--card-radius);padding:18px;box-shadow:var(--shadow);
    overflow:hidden;cursor:pointer;transition:transform .2s ease, filter .2s ease
  }
  .mod:hover{transform:translateY(-2px);filter:brightness(1.02)}
  .mod h4{margin:0 0 6px;font-size:16px;font-weight:700}
  .mod .desc{color:var(--muted);font-size:12px}
  .mod .kpi{font-size:26px;font-weight:800;margin-top:10px}
  .mod .foot{color:var(--muted);font-size:12px;margin-top:6px}
  .badge{position:absolute;top:12px;right:12px;background:var(--soft);border:1px solid #222;padding:6px 10px;border-radius:999px;font-size:12px}

  .grid{display:grid;gap:18px;grid-template-columns:repeat(3,1fr);margin-top:22px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)), var(--panel);
    border:1px solid #1c1c1c;border-radius:var(--card-radius);padding:16px 18px;box-shadow:var(--shadow);
    position:relative;overflow:hidden;cursor:pointer
  }
  .card h3{margin:0 0 4px;font-size:14px;font-weight:600;color:var(--muted)}
  .kpi-line{display:flex;align-items:center;justify-content:space-between}
  .kpi-value{font-size:28px;font-weight:700}
  .pill{font-size:12px;color:#0a0a0a;background:var(--primary);padding:4px 8px;border-radius:999px;font-weight:700}

  .charts{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin-top:18px}
  .chart-card{padding:18px}
  canvas{width:100%;height:100%}

  /* ===== Modal com iframe (zoom) ===== */
  .backdrop{
    position:fixed; inset:0; display:none; place-items:center;
    background:rgba(0,0,0,.55); backdrop-filter:saturate(110%) blur(4px); z-index:999;
  }
  .backdrop.show{display:grid}
  .modal{
    width:min(1200px,92vw); height:min(86vh,900px);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)), var(--panel);
    border:1px solid #1e1e1e; border-radius:22px; box-shadow:var(--shadow);
    transform:scale(.92); opacity:0; transition:transform .16s ease-out, opacity .16s ease-out;
    display:flex; flex-direction:column; overflow:hidden;
  }
  .backdrop.show .modal{transform:scale(1); opacity:1}
  .modal header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-bottom:1px solid #1f1f1f;background:rgba(17,17,17,.9)}
  .modal h2{margin:0;font-size:16px}
  .close{appearance:none;border:1px solid #2a2a2a;background:#0f0f0f;color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer}
  .modal iframe{border:0;width:100%;height:100%}

  @media (max-width:1280px){.modules{grid-template-columns:repeat(3,1fr)}.charts{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Dashboard Unificado</div>
        <div class="subtitle">Versão Desktop • Paleta do print preto (ciano/rosa)</div>
      </div>
      <div class="controls">
        <select id="empresa">
          <option value="TODAS">Todas as empresas</option>
          <option>MERCATTO DELICIA</option>
          <option>DELICIA GOURMET</option>
          <option>PADARIA DELICIA</option>
          <option>VILLA GOURMET</option>
          <option>M. KIDS</option>
        </select>
        <input type="month" id="periodo" />
        <button class="btn" id="btn-refresh">Atualizar</button>
      </div>
    </header>

    <!-- ===== Módulos ===== -->
    <section class="modules">
      <a class="mod" data-mod="METAS" id="link-metas" href="#"><span class="badge">Metas</span><h4>Metas</h4><div class="desc">Faturamento vs. objetivo</div><div class="kpi" id="kpi-metas">—</div><div class="foot"><span class="pill" style="background:#0f0f0f;border:1px solid #1e1e1e">Progresso</span></div></a>
      <a class="mod" data-mod="CANCELAMENTOS" id="link-cancel" href="#"><span class="badge">Cancelamentos</span><h4>Cancelamentos</h4><div class="desc">Itens/valor cancelado</div><div class="kpi" id="kpi-cancel">—</div><div class="foot"><span class="pill" style="background:var(--danger)">Risco</span></div></a>
      <a class="mod" data-mod="TRAVAS" id="link-travas" href="#"><span class="badge">Travas</span><h4>Travas de Compras</h4><div class="desc">Planos válidos e já comprado</div><div class="kpi" id="kpi-travas">—</div><div class="foot"><span class="pill" style="background:var(--warn)">Alerta</span></div></a>
      <a class="mod" data-mod="FINANCEIRO" id="link-fin" href="#"><span class="badge">Financeiro</span><h4>Resumo Financeiro</h4><div class="desc">Entradas x Saídas</div><div class="kpi" id="kpi-fin">—</div><div class="foot"><span class="pill" style="background:var(--ok)">Saldo</span></div></a>

      <a class="mod" data-mod="DELIVERY" id="link-delivery" href="#"><span class="badge">Delivery</span><h4>Vendas em Delivery</h4><div class="desc">Pedidos / ticket médio</div><div class="kpi" id="kpi-delivery">—</div><div class="foot"><span class="pill">Crescimento</span></div></a>
      <a class="mod" data-mod="CONCILIACAO" id="link-bank" href="#"><span class="badge">Bancária</span><h4>Conciliação Bancária</h4><div class="desc">Conferência de movimentos</div><div class="kpi" id="kpi-bank">—</div><div class="foot"><span class="pill" style="background:var(--accent)">Pendências</span></div></a>
      <a class="mod" data-mod="PESQUISA" id="link-nps" href="#"><span class="badge">NPS</span><h4>Pesquisa de Satisfação</h4><div class="desc">NPS / avaliações</div><div class="kpi" id="kpi-nps">—</div><div class="foot"><span class="pill" style="background:var(--ok)">Pontuação</span></div></a>
      <a class="mod" data-mod="MIDIAS" id="link-midias" href="#"><span class="badge">Mídias</span><h4>Mídias Sociais</h4><div class="desc">Views / engajamento</div><div class="kpi" id="kpi-views">—</div><div class="foot"><span class="pill" style="background:var(--accent)">Engaj.</span></div></a>
    </section>

    <!-- ===== KPIs gerais ===== -->
    <section class="grid">
      <div class="card" id="card-periodo">
        <h3>Período</h3>
        <div class="kpi-line"><div class="kpi-value" id="kpi-competencia">—</div><span class="pill">Abrir Pop-up</span></div>
      </div>
      <div class="card"><h3>Máquinas Stone</h3><div class="kpi-line"><div class="kpi-value" id="kpi-func-ativos">—</div><span class="pill" style="background:var(--accent)">Ativos</span></div></div>
      <div class="card"><h3>Requisições</h3><div class="kpi-line"><div class="kpi-value" id="kpi-credito">—</div><span class="pill" style="background:var(--ok)">Créditos</span></div></div>
    </section>

    <!-- ===== CHARTS ===== -->
    <section class="charts">
      <div class="card chart-card"><h3>Timeline geral</h3><canvas id="line-timeline" height="300"></canvas></div>
      <div class="card chart-card"><h3>Dias mais ativos</h3><canvas id="bar-days" height="300"></canvas></div>
    </section>

    <div class="subtitle" style="margin-top:16px">Última atualização: <span id="last-update">—</span></div>
  </div>

  <!-- ===== Pop-up interno (iframe do caixa.html) ===== -->
  <div id="backdrop" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <header>
        <h2 id="modal-title">Livro de Caixa — Detalhes</h2>
        <button class="close" id="modal-close">✕</button>
      </header>
      <iframe id="caixa-frame" src="about:blank" title="Caixa"></iframe>
    </div>
  </div>

<script>
/* ========= CONFIG ========= */
const CONFIG = {
  IFRAME_PAGE: 'caixa.html', // seu popup renomeado
  API_URL: 'https://script.google.com/macros/s/AKfycbzqg8GEPFmod6W1xPxneXHAC6LRmnNAastew3QJtMpsf8mWwRowcZKZoNgRQskBM0-p/exec'
};
const $ = s => document.querySelector(s);
const money = n => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n||0);
const toNumber = v => (typeof v==='number') ? v : Number(String(v||'').replace(/[^0-9,-]/g,'').replace(/\./g,'').replace(',','.'))||0;
const buildUrl = (base,params)=>{const u=new URL(base,window.location.href);Object.entries(params||{}).forEach(([k,v])=>{if(v!=null&&v!=='')u.searchParams.set(k,v)});return u.toString();};

/* ========= CHARTS ========= */
let chartLine, chartBar;
function makeLine(ctx){return new Chart(ctx,{type:'line',data:{labels:[],datasets:[
  {label:'Entradas',data:[],tension:.35,borderWidth:2,pointRadius:0,borderColor:'#00d1ff'},
  {label:'Saídas',data:[],tension:.35,borderWidth:2,pointRadius:0,borderColor:'#ff2e88'}
]},options:{plugins:{legend:{labels:{color:'#9aa3b8'}}},scales:{x:{ticks:{color:'#8b93a7'}},y:{grid:{color:'rgba(255,255,255,.06)'}}}});}
function makeBar(ctx){return new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'Movimentos',data:[],backgroundColor:'#00d1ff'}]},options:{plugins:{legend:{labels:{color:'#9aa3b8'}}},scales:{y:{grid:{color:'rgba(255,255,255,.06)'}}}});}

/* ========= API ========= */
async function fetchRows(empresa,periodo){
  const r = await fetch(buildUrl(CONFIG.API_URL,{action:'list',empresa,periodo}),{cache:'no-store'});
  if(!r.ok) throw new Error('Falha ao carregar linhas');
  const j = await r.json();
  return Array.isArray(j)?j:(j.items||j.rows||j.data||[]);
}
async function fetchHeader(empresa,periodo){
  // se seu Apps Script tiver action=header/resume, usamos; senão devolvemos null
  try{
    const r = await fetch(buildUrl(CONFIG.API_URL,{action:'header',empresa,periodo}),{cache:'no-store'});
    if(!r.ok) return null;
    return await r.json();
  }catch(_){return null}
}
function summarize(rows){
  let entradas=0,saidas=0; const byDay=new Map();
  for(const it of rows){
    const d=(it.data||it.Data||'').slice(0,10);
    const key=d.includes('/')?d.split('/').reverse().join('-'):d;
    const e=toNumber(it.entrada??it.Entrada), s=toNumber(it.saida??it.Saida);
    entradas+=e; saidas+=s;
    if(!byDay.has(key)) byDay.set(key,{e:0,s:0});
    byDay.get(key).e+=e; byDay.get(key).s+=s;
  }
  const labels=[...byDay.keys()].sort();
  return {entradas,saidas,labels,serieE:labels.map(k=>byDay.get(k).e),serieS:labels.map(k=>byDay.get(k).s),saldo:entradas-saidas};
}

/* ========= POP-UP (iframe) ========= */
const backdrop = $('#backdrop'), iframe = $('#caixa-frame');
function currentFilters(){ return { company: $('#empresa').value, periodo: $('#periodo').value }; }
function openModal(){
  iframe.src = buildUrl(CONFIG.IFRAME_PAGE, currentFilters());
  backdrop.classList.add('show');
  backdrop.setAttribute('aria-hidden','false');
}
function closeModal(){
  backdrop.classList.remove('show');
  backdrop.setAttribute('aria-hidden','true');
}
backdrop.addEventListener('click', e=>{ if(e.target===backdrop) closeModal(); });
$('#modal-close').addEventListener('click', closeModal);
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });
function syncIframeIfOpen(){ if(backdrop.classList.contains('show')) iframe.src = buildUrl(CONFIG.IFRAME_PAGE, currentFilters()); }

/* ========= LOAD ========= */
async function loadIndex(){
  const emp=$('#empresa').value, per=$('#periodo').value;
  $('#kpi-competencia').textContent = per.split('-').reverse().join('/');

  try{
    const [rows, header] = await Promise.all([ fetchRows(emp,per), fetchHeader(emp,per) ]);
    const s = summarize(rows);

    // KPIs reais
    $('#kpi-fin').textContent  = money(s.saldo);
    $('#kpi-cancel').textContent = '—';
    $('#kpi-travas').textContent = '—';
    $('#kpi-metas').textContent  = '—';
    $('#kpi-delivery').textContent = '—';
    $('#kpi-bank').textContent = '—';
    $('#kpi-nps').textContent = '—';
    $('#kpi-views').textContent = '—';

    // Saldo na loja (do cabeçalho, se vier)
    const saldoImpl = toNumber(header?.saldoImplantacao ?? header?.saldo_implantacao);
    const saldoLoja = header?.saldoNaLoja ?? header?.saldo_na_loja ?? (saldoImpl + s.entradas - s.saidas);
    const kLoja = document.getElementById('kpi-saldo-loja');
    if(kLoja){ kLoja.textContent = money(toNumber(saldoLoja)); }

    // Gráficos
    if(!chartLine) chartLine = makeLine(document.getElementById('line-timeline'));
    if(!chartBar)  chartBar  = makeBar(document.getElementById('bar-days'));

    const labelsBR = s.labels.map(x=>x.split('-').reverse().join('/'));
    chartLine.data.labels = labelsBR;
    chartLine.data.datasets[0].data = s.serieE;
    chartLine.data.datasets[1].data = s.serieS;
    chartLine.update();

    chartBar.data.labels = labelsBR;
    chartBar.data.datasets[0].data = s.serieE.map((v,i)=> v + (s.serieS[i]||0));
    chartBar.update();

    $('#last-update').textContent = new Date().toLocaleString('pt-BR');
  }catch(e){
    console.error(e);
    $('#kpi-fin').textContent = '—';
  }
}

/* ========= INIT ========= */
function init(){
  const month = new Date().toISOString().slice(0,7);
  $('#periodo').value = month;
  $('#kpi-competencia').textContent = month.split('-').reverse().join('/');

  chartLine = makeLine($('#line-timeline'));
  chartBar  = makeBar($('#bar-days'));

  // Abre pop-up (iframe) no card Período
  $('#card-periodo').addEventListener('click', openModal);

  // Filtros
  $('#btn-refresh').addEventListener('click', ()=>{ loadIndex(); syncIframeIfOpen(); });
  $('#empresa').addEventListener('change', ()=>{ loadIndex(); syncIframeIfOpen(); });
  $('#periodo').addEventListener('change', ()=>{ 
    $('#kpi-competencia').textContent = $('#periodo').value.split('-').reverse().join('/'); 
    loadIndex(); syncIframeIfOpen();
  });

  loadIndex();
}

window.addEventListener('DOMContentLoaded', ()=>{ try{ init(); } catch(err){ console.error(err); } });
</script>
</body>
</html>
