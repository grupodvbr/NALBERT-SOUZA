<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>CB Systems • Comparativo Mês Anterior</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg:#f6f8fb; --ink:#0f172a; --muted:#64748b; --card:#fff; --primary:#0ea5e9; --shadow:0 1px 8px rgba(0,0,0,.06);
    --red:#b91c1c; --green:#065f46; --amber:#92400e; --goodbg:#ecfdf5; --badbg:#fef2f2;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
  header{position:sticky;top:0;background:#0b1220;color:#fff;padding:14px 18px;font-weight:700;box-shadow:0 2px 12px rgba(0,0,0,.25)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  select,input[type="month"]{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
  .chip{display:flex;align-items:center;gap:8px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  .card{background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  .title{font-weight:800;margin:4px 2px 8px}
  .subtitle{color:var(--muted);font-size:12px;margin:-4px 2px 10px}
  .list{margin:0;padding-left:18px}
  .list li+li{margin-top:8px}
  .row{display:flex;justify-content:space-between;gap:10px;align-items:baseline}
  .small{color:var(--muted);font-size:12px}
  .progress{height:8px;background:#e5e7eb;border-radius:999px;margin-top:6px;overflow:hidden}
  .progress>span{display:block;height:100%;background:var(--primary);width:0;transition:width .25s;border-radius:999px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
  .pill.good{background:var(--goodbg);color:var(--green)}
  .pill.bad{background:var(--badbg);color:var(--red)}
  .note{color:#6b7280;font-size:12px;margin-top:6px}
  .split{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){.split{grid-template-columns:1fr 1fr}}
  .empty{color:#6b7280}
  .toggle{display:flex;gap:8px;align-items:center}
  .toggle input{accent-color:#0ea5e9}
</style>
</head>
<body>
<header>CB Systems • Comparativo Mês Anterior</header>

<div class="wrap">
  <div class="filters">
    <label>Empresa
      <select id="empresa">
        <option>MERCATTO DELICIA</option>
        <option>DELICIA GOURMET</option>
        <option>VILLA GOURMET</option>
        <option>M. KIDS</option>
        <option>PADARIA DELICIA</option>
      </select>
    </label>
    <label>Mês de referência
      <input id="periodo" type="month">
    </label>
    <div class="chip toggle">
      <input type="checkbox" id="modePct">
      <label for="modePct">Usar barras por % (em vez de R$)</label>
    </div>
    <button id="aplicar" style="border:none;background:#0ea5e9;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer">Aplicar</button>
  </div>

  <div id="content" class="grid"></div>
</div>

<script>
/* ===== CONFIG ===== */
const API_BASE='https://script.google.com/macros/s/AKfycbyDGQ-srD7OFMORoRo7ZH2BDaz_tJVVlsqjdlLTI0OpkEKv3tQ5Ny02h3blo7GKjsFEIw/exec';

/* ===== HELPERS ===== */
const moeda=v=>Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const parseBR=v=>{ if(v==null||v==='')return 0; if(typeof v==='number')return v; const s=String(v).replace(/[^\d\-.,]/g,'').replace(/\.(?=\d{3})/g,'').replace(',','.'); const n=Number(s); return isNaN(n)?0:n; };
const norm=s=>String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^A-Za-z0-9 ]/g,'').replace(/\s+/g,' ').trim().toUpperCase();
function prevMonthStr(ym){ if(!/^\d{4}-\d{2}$/.test(ym||'')){ const d=new Date(); d.setMonth(d.getMonth()-1); return d.toISOString().slice(0,7); } const [y,m]=ym.split('-').map(Number); const d=new Date(y,m-1,1); d.setMonth(d.getMonth()-1); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function extractPlanos(rec){
  if (Array.isArray(rec?.planosFonte9) && rec.planosFonte9.length) return rec.planosFonte9.map(p=>({nome:String(p.nome??'—'),valor:Math.abs(parseBR(p.valor||0))}));
  const grid = rec?.grid || rec?.tabela;
  if (Array.isArray(grid) && Array.isArray(grid[0]) && grid[0].length >= 3) {
    const out=[]; for(let r=0;r<grid.length;r++){ const nome=grid[r][1]; const val=parseBR(grid[r][2]); if(nome!=null && nome!=='' && !isNaN(val) && val!==0) out.push({nome:String(nome), valor:Math.abs(val)}); }
    if(out.length) return out;
  }
  if (Array.isArray(rec?.fonte9Detalhe) && rec.fonte9Detalhe.length) return rec.fonte9Detalhe.map(i=>({nome:i.nome??i.planocontas??i.categoria??'—',valor:Math.abs(parseBR(i.valor||i.total||0))}));
  if (Array.isArray(rec?.categorias)){ const out=[]; rec.categorias.forEach(c=>(c.subs||[]).forEach(s=>{ if(Number(s.font)===9) out.push({nome:s.nome??'—',valor:Math.abs(parseBR(s.valor||0))})})); if(out.length) return out; }
  return [];
}
function planosToMap(planos){ const map={}; (planos||[]).forEach(p=>{ const k=String(p.nome); map[k]=(map[k]||0)+Math.abs(parseBR(p.valor||0)); }); return map; }
async function fetchJSON(url, {timeout=12000}={}){ const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(),timeout); const r=await fetch(url,{signal:ctrl.signal,cache:'no-store'}).catch(e=>{throw e}); clearTimeout(to); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function getEmpresaPeriodo(emp, periodo){
  const url=`${API_BASE}?empresa=${encodeURIComponent(emp)}${periodo?`&periodo=${encodeURIComponent(periodo)}`:''}`;
  const j=await fetchJSON(url);
  if(j?.empresa) return j;
  if(Array.isArray(j?.data)) return j.data.find(x=>norm(x.empresa||x.Empresa)===norm(emp))||j.data[0];
  if(Array.isArray(j)) return j.find(x=>norm(x.empresa||x.Empresa)===norm(emp))||j[0];
  return j;
}

/* ===== UI ===== */
const selEmpresa=document.getElementById('empresa');
const inpPeriodo=document.getElementById('periodo');
const btnAplicar=document.getElementById('aplicar');
const chkPct=document.getElementById('modePct');
const content=document.getElementById('content');

function skeleton(){
  return `
    <div class="card"><div class="title">Resumo</div>
      <div class="small">Carregando…</div>
      <div class="progress"><span style="width:35%"></span></div>
    </div>
    <div class="split">
      <div class="card"><div class="title">Aumentos por Plano (Top 20)</div><ul class="list"><li>Carregando…</li></ul></div>
      <div class="card"><div class="title">Quedas por Plano (Top 20)</div><ul class="list"><li>Carregando…</li></ul></div>
    </div>`;
}

function render(rowsInc, rowsDec, meta, usePct){
  content.innerHTML = `
    <div class="card">
      <div class="title">${meta.empresa} — ${meta.currLabel} vs ${meta.prevLabel}</div>
      <div class="subtitle">Base: valores por Plano de Contas | Barras por ${usePct?'variação percentual (%)':'variação em R$'}</div>
      <div class="row">
        <div>Total do mês anterior: <b>${moeda(meta.prevTotal)}</b></div>
        <div>Atual: <b>${moeda(meta.currTotal)}</b> <span class="pill ${meta.currTotal>=meta.prevTotal?'bad':'good'}" style="margin-left:6px">
          ${meta.currTotal>=meta.prevTotal?'+':'−'} ${moeda(Math.abs(meta.currTotal-meta.prevTotal))}</span>
        </div>
      </div>
      <div class="progress"><span style="width:${Math.min(100, (meta.currTotal/(meta.prevTotal||1))*100)}%"></span></div>
      <div class="note">Se a barra passar de 100%, o total atual supera o mês anterior.</div>
    </div>

    <div class="split">
      <div class="card" id="inc">
        <div class="title">Aumentos por Plano (Top 20)</div>
        <ul class="list" data-inc></ul>
      </div>
      <div class="card" id="dec">
        <div class="title">Quedas por Plano (Top 20)</div>
        <ul class="list" data-dec></ul>
      </div>
    </div>
  `;

  const ulInc=content.querySelector('[data-inc]');
  const ulDec=content.querySelector('[data-dec]');

  if(!rowsInc.length) ulInc.innerHTML='<li class="empty">Nenhum plano aumentou no período.</li>';
  else {
    const base = usePct ? (rowsInc[0]?.pct||1) : (rowsInc[0]?.inc||1);
    ulInc.innerHTML = rowsInc.map((r,i)=>`
      <li>
        <div class="row">
          <div><b>${i+1}º</b> ${r.nome}</div>
          <div style="white-space:nowrap"><b>${usePct? r.pct.toFixed(1)+'%':moeda(r.inc)}</b></div>
        </div>
        <div class="small">de ${moeda(r.antes)} → ${moeda(r.atual)}</div>
        <div class="progress"><span style="width:${Math.min(100,(usePct?(r.pct/base*100):(r.inc/base*100)))}%"></span></div>
      </li>`).join('');
  }

  if(!rowsDec.length) ulDec.innerHTML='<li class="empty">Nenhum plano reduziu no período.</li>';
  else {
    const base = usePct ? Math.abs(rowsDec[0]?.pct||1) : Math.abs(rowsDec[0]?.inc||1);
    ulDec.innerHTML = rowsDec.map((r,i)=>`
      <li>
        <div class="row">
          <div><b>${i+1}º</b> ${r.nome}</div>
          <div style="white-space:nowrap"><b>${usePct? r.pct.toFixed(1)+'%':moeda(Math.abs(r.inc))}</b></div>
        </div>
        <div class="small">de ${moeda(r.antes)} → ${moeda(r.atual)}</div>
        <div class="progress"><span style="width:${Math.min(100,(usePct?(Math.abs(r.pct)/base*100):(Math.abs(r.inc)/base*100)))}%"></span></div>
      </li>`).join('');
  }
}

function buildRows(mapCurr, mapPrev){
  const nomes = new Set([...Object.keys(mapCurr), ...Object.keys(mapPrev)]);
  const rows=[];
  nomes.forEach(nome=>{
    const atual=mapCurr[nome]||0;
    const antes=mapPrev[nome]||0;
    const inc=atual-antes;
    const pct = antes>0 ? (inc/antes*100) : (inc>0?100:(atual===0?0:-100));
    rows.push({nome, antes, atual, inc, pct});
  });
  const incs = rows.filter(r=>r.inc>0).sort((a,b)=>b.inc-a.inc).slice(0,20);
  const decs = rows.filter(r=>r.inc<0).sort((a,b)=>a.inc-b.inc).slice(0,20); // mais negativas primeiro
  return {incs,decs};
}

/* ===== ACTION ===== */
async function run(){
  const emp=selEmpresa.value;
  const per=inpPeriodo.value || new Date().toISOString().slice(0,7);
  const prev=prevMonthStr(per);

  content.innerHTML=skeleton();

  try{
    const [curr, old] = await Promise.all([ getEmpresaPeriodo(emp, per), getEmpresaPeriodo(emp, prev) ]);

    if(curr?.matchesPeriod===false){ content.innerHTML='<div class="card"><div class="title">Sem dados</div><div class="small">Não há dados para este mês.</div></div>'; return; }
    if(!old || old?.matchesPeriod===false){ content.innerHTML='<div class="card"><div class="title">Sem comparação</div><div class="small">Não encontramos dados do mês anterior.</div></div>'; return; }

    const planosCurr = extractPlanos(curr);
    const planosPrev = extractPlanos(old);
    const mapCurr = planosToMap(planosCurr);
    const mapPrev = planosToMap(planosPrev);
    const {incs,decs} = buildRows(mapCurr, mapPrev);

    const meta = {
      empresa: emp,
      currLabel: per.split('-').reverse().join('/'),
      prevLabel: prev.split('-').reverse().join('/'),
      currTotal: Object.values(mapCurr).reduce((a,b)=>a+b,0),
      prevTotal: Object.values(mapPrev).reduce((a,b)=>a+b,0)
    };

    render(incs, decs, meta, chkPct.checked);

  }catch(e){
    console.error(e);
    content.innerHTML='<div class="card"><div class="title">Erro ao carregar</div><div class="small">Tente novamente em instantes.</div></div>';
  }
}

/* init */
document.getElementById('aplicar').addEventListener('click', run);
document.getElementById('modePct').addEventListener('change', run);
window.addEventListener('DOMContentLoaded', ()=>{
  const d=new Date(); inpPeriodo.value=d.toISOString().slice(0,7); run();
});
</script>
</body>
</html>
