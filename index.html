<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Unificado</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{ --bg:#0a0a0a; --panel:#111111; --soft:#161616; --ink:#f5f7ff; --muted:#a9b0c2; --primary:#00d1ff; --accent:#ff2e88; --ok:#37d399; --warn:#fec84b; --danger:#f43f5e; --card-radius:18px; --shadow:0 10px 40px rgba(0,0,0,.45); }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:
      radial-gradient(1100px 720px at 65% -10%, rgba(0,209,255,.12), transparent 60%),
      radial-gradient(900px 540px at -10% 15%, rgba(255,46,136,.10), transparent 55%),
      var(--bg); color:var(--ink);
  }
  .wrap{max-width:1500px;margin:32px auto;padding:0 24px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
  .title{font-size:28px;font-weight:700;letter-spacing:.3px}
  .subtitle{color:var(--muted);font-size:14px}
  .controls{display:flex;gap:12px;align-items:center}
  .btn, select, input[type="month"]{background:var(--panel);border:1px solid #1f1f1f;color:var(--ink);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow)}
  .btn{cursor:pointer}.btn:hover{filter:brightness(1.08)}
  select{appearance:none}

  .modules{display:grid;gap:18px;grid-template-columns:repeat(4,1fr)}
  .mod{position:relative;background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)),var(--panel);border:1px solid #1e1e1e;border-radius:var(--card-radius);padding:18px;box-shadow:var(--shadow);overflow:hidden;cursor:pointer;transition:transform .2s ease, filter .2s ease}
  .mod:hover{transform:translateY(-2px);filter:brightness(1.02)}
  .mod h4{margin:0 0 6px;font-size:16px;font-weight:700}
  .mod .desc{color:var(--muted);font-size:12px}
  .mod .kpi{font-size:26px;font-weight:800;margin-top:10px}
  .badge{position:absolute;top:12px;right:12px;background:var(--soft);border:1px solid #222;padding:6px 10px;border-radius:999px;font-size:12px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#0f0f0f;border:1px solid #1e1e1e;padding:6px 10px;border-radius:999px;font-size:12px}
  .chip i{width:8px;height:8px;border-radius:999px;background:var(--primary)}

  .grid{display:grid;gap:18px;grid-template-columns:repeat(3,1fr);margin-top:22px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)), var(--panel);border:1px solid #1c1c1c;border-radius:var(--card-radius);padding:16px 18px;box-shadow:var(--shadow);position:relative;overflow:hidden;cursor:pointer}
  .card h3{margin:0 0 4px;font-size:14px;font-weight:600;color:var(--muted)}
  .kpi-line{display:flex;align-items:center;justify-content:space-between}
  .kpi-value{font-size:28px;font-weight:700}
  .pill{font-size:12px;color:#0a0a0a;background:var(--primary);padding:4px 8px;border-radius:999px;font-weight:700}

  .charts{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin-top:18px}
  .chart-card{padding:18px}
  canvas{width:100%;height:100%}

  /* ===== Modal (pop-up interno) ===== */
  .backdrop{
    position:fixed; inset:0; display:none; place-items:center;
    background:rgba(0,0,0,.55); backdrop-filter:saturate(110%) blur(4px);
    z-index:999;
  }
  .backdrop.show{ display:grid; }
  .modal{
    width:min(1100px, 92vw); max-height:86vh; overflow:auto;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)), var(--panel);
    border:1px solid #1e1e1e; border-radius:22px; box-shadow: var(--shadow);
    transform: scale(.92); opacity:0;
    transition: transform .16s ease-out, opacity .16s ease-out;
  }
  .backdrop.show .modal{ transform:scale(1); opacity:1; } /* efeito de ZOOM */
  .modal header{
    position:sticky; top:0; z-index:1; display:flex; align-items:center; gap:10px;
    justify-content:space-between; padding:14px 16px; background:rgba(17,17,17,.9);
    border-bottom:1px solid #1f1f1f;
  }
  .modal h2{margin:0;font-size:18px}
  .close{appearance:none;border:1px solid #2a2a2a;background:#0f0f0f;color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer}
  .modal .content{padding:14px 16px}
  .filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
  .filters select,.filters input{background:var(--soft);border:1px solid #232323;color:var(--ink);padding:8px 10px;border-radius:10px}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:8px 0 14px}
  .k{background:#0f0f0f;border:1px solid #1f1f1f;border-radius:14px;padding:12px}
  .k .label{color:var(--muted);font-size:12px}
  .k .val{font-size:22px;font-weight:800;margin-top:4px}
  table{width:100%;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#0f0f0f;border-bottom:1px solid #222;padding:10px 8px;text-align:left}
  tbody td{border-bottom:1px solid #1a1a1a;padding:8px}
  .num{text-align:right}
  .ok{color:var(--ok)} .danger{color:var(--danger)}

  @media(max-width:1100px){ .kpis{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">Dashboard Unificado</div>
      <div class="subtitle">Versão Desktop • Paleta do print preto (ciano/rosa)</div>
    </div>
    <div class="controls">
      <select id="empresa">
        <option value="TODAS">Todas as empresas</option>
        <option>MERCATTO DELICIA</option>
        <option>DELICIA GOURMET</option>
        <option>PADARIA DELICIA</option>
        <option>VILLA GOURMET</option>
        <option>M. KIDS</option>
      </select>
      <input type="month" id="periodo" />
      <button class="btn" id="btn-refresh">Atualizar</button>
    </div>
  </header>

  <!-- Módulos -->
  <section class="modules">
    <div class="mod"><span class="badge">Financeiro</span><h4>Resumo Financeiro</h4><div class="desc">Entradas x Saídas</div><div class="kpi" id="kpi-fin">—</div><div class="foot"><span class="chip"><i></i> Saldo</span></div></div>
    <div class="mod"><span class="badge">Entradas</span><h4>Total de Entradas</h4><div class="desc">Somatório no mês</div><div class="kpi" id="kpi-ent">—</div></div>
    <div class="mod"><span class="badge">Saídas</span><h4>Total de Saídas</h4><div class="desc">Somatório no mês</div><div class="kpi" id="kpi-said">—</div></div>
    <div class="mod"><span class="badge">Loja</span><h4>Saldo na Loja</h4><div class="desc">Cabeçalho da planilha</div><div class="kpi" id="kpi-saldo-loja">—</div></div>
  </section>

  <!-- KPIs gerais -->
  <section class="grid">
    <div class="card" id="card-periodo" role="button" tabindex="0">
      <h3>Período</h3>
      <div class="kpi-line"><div class="kpi-value" id="kpi-competencia">—</div><span class="pill">Abrir Pop-up</span></div>
    </div>
    <div class="card"><h3>Máquinas Stone</h3><div class="kpi-line"><div class="kpi-value">—</div><span class="pill" style="background:var(--accent)">Ativos</span></div></div>
    <div class="card"><h3>Requisições</h3><div class="kpi-line"><div class="kpi-value">—</div><span class="pill" style="background:var(--ok)">Créditos</span></div></div>
  </section>

  <!-- CHARTS -->
  <section class="charts">
    <div class="card chart-card"><h3>Timeline geral</h3><canvas id="line-timeline" height="300"></canvas></div>
    <div class="card chart-card"><h3>Dias mais ativos</h3><canvas id="bar-days" height="300"></canvas></div>
  </section>

  <div class="subtitle" style="margin-top:16px">Última atualização: <span id="last-update">—</span></div>
</div>

<!-- ===== Modal (pop-up interno) ===== -->
<div id="backdrop" class="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="m-title">
    <header>
      <h2 id="m-title">Livro de Caixa — Detalhes</h2>
      <button class="close" id="m-close">✕</button>
    </header>
    <div class="content">
      <div class="filters">
        <select id="m-empresa">
          <option value="TODAS">Todas as empresas</option>
          <option>MERCATTO DELICIA</option>
          <option>DELICIA GOURMET</option>
          <option>PADARIA DELICIA</option>
          <option>VILLA GOURMET</option>
          <option>M. KIDS</option>
        </select>
        <input type="month" id="m-periodo" />
        <input id="m-busca" placeholder="histórico ou complemento" style="flex:1 1 260px">
        <button class="btn" id="m-export">Exportar CSV</button>
      </div>

      <div class="kpis">
        <div class="k"><div class="label">Saldo na implantação</div><div class="val" id="k-impl">—</div></div>
        <div class="k"><div class="label">Total de Entradas</div><div class="val ok" id="k-ent">—</div></div>
        <div class="k"><div class="label">Total de Saídas</div><div class="val danger" id="k-said">—</div></div>
        <div class="k"><div class="label">Saldo na Loja</div><div class="val" id="k-loja">—</div></div>
      </div>

      <table id="m-table">
        <thead><tr>
          <th style="width:110px">Data</th>
          <th>Histórico</th>
          <th>Complemento</th>
          <th class="num" style="width:120px">Entrada</th>
          <th class="num" style="width:120px">Saída</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG (dados reais) ====== */
const API_URL = 'https://script.google.com/macros/s/AKfycbzqg8GEPFmod6W1xPxneXHAC6LRmnNAastew3QJtMpsf8mWwRowcZKZoNgRQskBM0-p/exec';
const $ = s => document.querySelector(s);
const money = n => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n||0);
const toNumber = v => (typeof v==='number') ? v : Number(String(v||'').replace(/[^0-9,-]/g,'').replace(/\./g,'').replace(',','.'))||0;
const build = (base,params)=>{const u=new URL(base);Object.entries(params||{}).forEach(([k,v])=>{if(v!=null&&v!=='')u.searchParams.set(k,v)});return u;};

/* ====== Gráficos ====== */
let chartLine, chartBar;
function makeLine(ctx){return new Chart(ctx,{type:'line',data:{labels:[],datasets:[
  {label:'Entradas',data:[],tension:.35,borderWidth:2,pointRadius:0,borderColor:'#00d1ff'},
  {label:'Saídas',data:[],tension:.35,borderWidth:2,pointRadius:0,borderColor:'#ff2e88'}
]},options:{plugins:{legend:{labels:{color:'#9aa3b8'}}},scales:{x:{ticks:{color:'#8b93a7'}},y:{grid:{color:'rgba(255,255,255,.06)'}}}});}
function makeBar(ctx){return new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'Movimentos',data:[],backgroundColor:'#00d1ff'}]},options:{plugins:{legend:{labels:{color:'#9aa3b8'}}},scales:{y:{grid:{color:'rgba(255,255,255,.06)'}}}});}

/* ====== API ====== */
async function fetchRows(empresa,periodo){
  const r = await fetch(build(API_URL,{action:'list',empresa,periodo}),{cache:'no-store'});
  if(!r.ok) throw new Error('Falha ao carregar'); 
  const j = await r.json();
  return Array.isArray(j)?j:(j.items||j.rows||[]);
}
function summarize(rows){
  let e=0,s=0; const map=new Map();
  for(const it of rows){
    const d = (it.data||it.Data||'').slice(0,10);
    const iso = d.includes('/')?d.split('/').reverse().join('-'):d;
    const en = toNumber(it.entrada??it.Entrada), sa = toNumber(it.saida??it.Saida);
    e+=en; s+=sa;
    if(!map.has(iso)) map.set(iso,{e:0,s:0});
    map.get(iso).e+=en; map.get(iso).s+=sa;
  }
  const labels=[...map.keys()].sort();
  return {entradas:e,saidas:s,labels,serieE:labels.map(k=>map.get(k).e),serieS:labels.map(k=>map.get(k).s),saldo:e-s};
}

/* ====== Dashboard ====== */
async function loadIndex(){
  const emp=$('#empresa').value, per=$('#periodo').value;
  $('#kpi-competencia').textContent = per.split('-').reverse().join('/');
  const rows = await fetchRows(emp,per);
  const s = summarize(rows);
  $('#kpi-fin').textContent = money(s.saldo);
  $('#kpi-ent').textContent = money(s.entradas);
  $('#kpi-said').textContent = money(s.saidas);

  // saldo na loja (se vier no JSON raiz/primeira entrada)
  const saldoLoja = toNumber(rows?.saldo_loja ?? rows?.SaldoLoja ?? rows?.[0]?.saldo_loja ?? rows?.[0]?.SaldoLoja);
  if(saldoLoja) $('#kpi-saldo-loja').textContent = money(saldoLoja);

  if(!chartLine) chartLine = makeLine($('#line-timeline'));
  if(!chartBar)  chartBar  = makeBar($('#bar-days'));
  const labelsBR = s.labels.map(x=>x.split('-').reverse().join('/'));
  chartLine.data.labels = labelsBR; chartLine.data.datasets[0].data=s.serieE; chartLine.data.datasets[1].data=s.serieS; chartLine.update();
  chartBar.data.labels = labelsBR;  chartBar.data.datasets[0].data=s.serieE.map((v,i)=>v+(s.serieS[i]||0)); chartBar.update();
  $('#last-update').textContent = new Date().toLocaleString('pt-BR');
}

/* ====== Modal (pop-up interno) ====== */
function openModal(){ const b=$('#backdrop'); b.classList.add('show'); b.setAttribute('aria-hidden','false'); loadModal(); }
function closeModal(){ const b=$('#backdrop'); b.classList.remove('show'); b.setAttribute('aria-hidden','true'); }

function filterRowsByText(rows, q){
  if(!q) return rows;
  const s=q.trim().toLowerCase();
  return rows.filter(r =>
    String(r.historico||r.Historico||'').toLowerCase().includes(s) ||
    String(r.complemento||r.Complemento||'').toLowerCase().includes(s)
  );
}

async function loadModal(){
  $('#m-empresa').value = $('#empresa').value;
  $('#m-periodo').value = $('#periodo').value;

  const emp=$('#m-empresa').value, per=$('#m-periodo').value;
  const all = await fetchRows(emp,per);

  // KPIs
  const sums = summarize(all);
  $('#k-ent').textContent  = money(sums.entradas);
  $('#k-said').textContent = money(sums.saidas);
  const impl = toNumber(all?.saldo_implantacao ?? all?.SaldoImplantacao);
  const loja = toNumber(all?.saldo_loja ?? all?.SaldoLoja);
  $('#k-impl').textContent = impl?money(impl):'—';
  $('#k-loja').textContent = loja?money(loja):'—';

  // Tabela
  renderTable(filterRowsByText(all, $('#m-busca').value));
}

function renderTable(rows){
  const tb=$('#m-table tbody'); tb.innerHTML='';
  for(const r of rows){
    const e=toNumber(r.entrada??r.Entrada), s=toNumber(r.saida??r.Saida);
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${(r.data||r.Data||'').slice(0,10)}</td>
      <td>${r.historico||r.Historico||''}</td>
      <td>${r.complemento||r.Complemento||''}</td>
      <td class="num ok">${e?money(e):''}</td>
      <td class="num danger">${s?money(s):''}</td>`;
    tb.appendChild(tr);
  }
}

function exportCSV(){
  const rows=[...document.querySelectorAll('#m-table tbody tr')].map(tr=>[...tr.children].map(td=>td.textContent));
  const csv=[['Data','Histórico','Complemento','Entrada','Saída'], ...rows].map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(';')).join('\r\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`livro-caixa-${($('#m-empresa').value||'todas').replace(/\s+/g,'_')}-${$('#m-periodo').value}.csv`; a.click();
}

/* ====== Init ====== */
function init(){
  const month=new Date().toISOString().slice(0,7);
  $('#periodo').value=month; $('#kpi-competencia').textContent=month.split('-').reverse().join('/');

  chartLine = makeLine($('#line-timeline'));
  chartBar  = makeBar($('#bar-days'));
  loadIndex();

  $('#btn-refresh').addEventListener('click', loadIndex);
  $('#empresa').addEventListener('change', loadIndex);
  $('#periodo').addEventListener('change', ()=>{ $('#kpi-competencia').textContent=$('#periodo').value.split('-').reverse().join('/'); loadIndex(); });

  // Modal handlers
  $('#card-periodo').addEventListener('click', openModal);
  $('#m-close').addEventListener('click', closeModal);
  $('#backdrop').addEventListener('click', e=>{ if(e.target.id==='backdrop') closeModal(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

  // Filtros internos do modal
  $('#m-empresa').addEventListener('change', loadModal);
  $('#m-periodo').addEventListener('change', loadModal);
  $('#m-busca').addEventListener('input', async ()=>{
    const emp=$('#m-empresa').value, per=$('#m-periodo').value;
    const all = await fetchRows(emp,per);
    renderTable(filterRowsByText(all, $('#m-busca').value));
  });
  $('#m-export').addEventListener('click', exportCSV);
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
